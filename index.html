<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Tree Dashboard - Worksection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .shimmer {
            animation: shimmer 2s infinite;
            background: linear-gradient(to right, #f0f0f0 4%, #e0e0e0 25%, #f0f0f0 36%);
            background-size: 1000px 100%;
        }
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
        }
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .recommendation-tab {
            transition: all 0.3s ease;
        }
        .recommendation-tab.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }
        .recommendation-content {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .gap-card {
            transition: all 0.3s ease;
        }
        .gap-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* Search styles */
        .filter-chip {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            border: 1px solid #e5e7eb;
            background-color: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .filter-chip:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        .filter-chip.active {
            background-color: #2563eb;
            border-color: #2563eb;
            color: white;
        }
        .search-result-item {
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-result-item:hover {
            background-color: #f9fafb;
        }
        .search-result-item.selected {
            background-color: #eff6ff;
            border-left: 3px solid #2563eb;
        }
        mark {
            background-color: #fef08a;
            padding: 0 0.125rem;
            border-radius: 0.125rem;
        }

        /* Tree visualization styles */
        .node rect {
            transition: all 0.3s ease;
        }
        .node rect:hover {
            filter: brightness(0.95);
            stroke-width: 4 !important;
        }
        .node text {
            user-select: none;
            pointer-events: none;
        }
        .link {
            transition: all 0.3s ease;
        }
        #treeContainer::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        #treeContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #treeContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }
        #treeContainer::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dashboard-tab {
            transition: all 0.3s ease;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid transparent;
        }
        .tab-content {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">–î–∞—à–±–æ—Ä–¥ –î–µ—Ä–µ–≤–∞ –ö–æ–Ω—Ç–µ–Ω—Ç—É</h1>
                            <p class="text-sm text-gray-500">–°–∏—Å—Ç–µ–º–∞ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –ö–æ–Ω—Ç–µ–Ω—Ç—É Worksection</p>
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div class="flex-1 max-w-2xl mx-8 relative">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input
                                type="text"
                                id="globalSearch"
                                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent sm:text-sm"
                                placeholder="–ü–æ—à—É–∫ —Ñ–∞–π–ª—ñ–≤, –∫–æ–Ω—Ç–µ–Ω—Ç—É, —Ñ—É–Ω–∫—Ü—ñ–π... (Cmd+K)"
                                autocomplete="off"
                            />
                        </div>

                        <!-- Search Suggestions Dropdown -->
                        <div id="searchSuggestions" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-96 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500">–û–Ω–æ–≤–ª–µ–Ω–æ: <strong id="lastUpdate">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</strong></span>

                        <!-- Tree View Toggle -->
                        <button onclick="toggleTreeView()" id="treeToggleBtn" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 flex items-center space-x-2 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            <span>–î–µ—Ä–µ–≤–æ</span>
                        </button>

                        <button onclick="refreshData()" id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2 disabled:opacity-50">
                            <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span>–û–Ω–æ–≤–∏—Ç–∏</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Content -->
                <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">–ó–ê–ì–ê–õ–¨–ù–ï</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-3xl font-bold text-gray-900"><span id="totalContent">0</span></p>
                        <p class="text-sm text-gray-500">–í—Å—å–æ–≥–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</p>
                        <div class="mt-3 space-y-1 text-xs">
                            <div class="text-green-600 font-medium">WS 1.0: <span id="ws10Count">0</span></div>
                            <div class="text-orange-600 font-medium">WS 2.0: <span id="ws20Count">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Published Content -->
                <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded">–û–ü–£–ë–õ–Ü–ö–û–í–ê–ù–û</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-3xl font-bold text-gray-900"><span id="publishedContent">0</span></p>
                        <p class="text-sm text-gray-500">–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</p>
                        <div class="flex items-center mt-3 text-green-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-xs font-medium">+<span id="weekGrowth">0</span> —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è</span>
                        </div>
                    </div>
                </div>

                <!-- Not Published -->
                <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-orange-700 bg-orange-100 px-2 py-1 rounded">–ù–ï –û–ü–£–ë–õ–Ü–ö–û–í–ê–ù–û</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-3xl font-bold text-gray-900"><span id="notPublishedContent">0</span></p>
                        <p class="text-sm text-gray-500">–ì–æ—Ç–æ–≤–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</p>
                        <div class="flex items-center mt-3 text-orange-500">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-xs font-medium">–û—á—ñ–∫—É—î –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</span>
                        </div>
                    </div>
                </div>

                <!-- Growth Trend -->
                <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-purple-700 bg-purple-100 px-2 py-1 rounded">–ó–†–û–°–¢–ê–ù–ù–Ø</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-3xl font-bold text-gray-900">+<span id="monthGrowth">0</span></p>
                        <p class="text-sm text-gray-500">–ó–∞ –º—ñ—Å—è—Ü—å</p>
                        <div class="flex items-center mt-3 text-purple-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-xs font-medium">~<span id="weeklyAvg">0</span> –≤ —Å–µ—Ä–µ–¥–Ω—å–æ–º—É/—Ç–∏–∂–¥–µ–Ω—å</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Funnel Stages Overview -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-6">–ü–æ–∫—Ä–∏—Ç—Ç—è –ø–æ —Å—Ç–∞–¥—ñ—è—Ö –≤–æ—Ä–æ–Ω–∫–∏</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="stagesContainer">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>


            <!-- Content Performance & Activity Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

                <!-- Content Type Distribution -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Ç–∏–ø–∞–º–∏</h2>
                    <div class="h-64">
                        <canvas id="contentTypeChart"></canvas>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-6" id="contentTypeLegend">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Status Distribution -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">–°—Ç–∞—Ç—É—Å–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</h2>
                    <div class="h-64">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-6" id="statusLegend">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Language Coverage & Recent Changes -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

                <!-- Language Coverage -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">üåê –ü–æ–∫—Ä–∏—Ç—Ç—è –ø–æ –º–æ–≤–∞—Ö</h2>
                    <div class="space-y-3" id="languageList">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-semibold text-gray-900">üìù –û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</h2>
                    </div>
                    <div class="scrollable-content space-y-4" id="recentActivity">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Gaps Section - Two Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- WS 1.0 Gaps -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">‚ö†Ô∏è –ü—Ä–æ–≥–∞–ª–∏–Ω–∏ WS 1.0</h2>
                        <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded" id="ws10GapsCount">0</span>
                    </div>
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–†–æ–∑–¥—ñ–ª</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">–û—Ü—ñ–Ω–∫–∞</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">–§–∞–π–ª–∏</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="gapsTableWs10">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- WS 2.0 Gaps -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">‚ö†Ô∏è –ü—Ä–æ–≥–∞–ª–∏–Ω–∏ WS 2.0</h2>
                        <span class="text-xs font-medium text-orange-700 bg-orange-100 px-2 py-1 rounded" id="ws20GapsCount">0</span>
                    </div>
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–†–æ–∑–¥—ñ–ª</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">–û—Ü—ñ–Ω–∫–∞</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">–§–∞–π–ª–∏</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="gapsTableWs20">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tree Visualization (hidden - now fullscreen only) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Content Tree Visualization</h2>
                            <p class="text-sm text-gray-600">Interactive horizontal tree view of content structure</p>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex items-center space-x-3">
                        <select id="treeStageSelect" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <optgroup label="WS 1.0">
                                <option value="WS 1.0/Pre-Registration">Pre-Registration (TOFU)</option>
                                <option value="WS 1.0/Trial">Trial (MOFU)</option>
                                <option value="WS 1.0/Success_Client">Success_Client (BOFU)</option>
                            </optgroup>
                            <option value="WS 2.0 Release">WS 2.0 Release</option>
                        </select>
                        <button onclick="expandAllNodes()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center space-x-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å–µ</span>
                        </button>
                        <button onclick="collapseAllNodes()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-medium flex items-center space-x-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                            </svg>
                            <span>–ó–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å–µ</span>
                        </button>
                    </div>
                </div>

                <!-- Legend -->
                <div class="mb-4 flex items-center space-x-6 text-sm bg-gray-50 p-3 rounded-lg">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded-full bg-green-500"></div>
                        <span class="text-gray-700">–Ñ –∫–æ–Ω—Ç–µ–Ω—Ç (‚úÖ)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded-full bg-red-500"></div>
                        <span class="text-gray-700">–ü–æ—Ä–æ–∂–Ω—è (‚ùå)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded-full bg-yellow-400"></div>
                        <span class="text-gray-700">–û—á—ñ–∫—É–≤–∞–Ω–æ –ø–æ—Ä–æ–∂–Ω—è (üü°)</span>
                    </div>
                    <div class="ml-auto text-xs text-gray-500">
                        <span class="font-semibold">–ü—ñ–¥–∫–∞–∑–∫–∞:</span> –ö–ª—ñ–∫–∞–π—Ç–µ –≤—É–∑–ª–∏ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –≥—ñ–ª–æ–∫
                    </div>
                </div>

                <!-- SVG Container -->
                <div id="treeContainer" class="overflow-auto border border-gray-200 rounded-lg bg-gray-50" style="height: 70vh;">
                    <svg id="treeSvg"></svg>
                </div>
            </div>

        </main>

        <!-- Search Results Modal -->
        <div id="searchResultsModal" class="hidden fixed inset-0 z-50">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeSearchModal()"></div>

            <!-- Modal container -->
            <div class="fixed inset-0 overflow-y-auto">
                <div class="min-h-full p-4">
                    <!-- Modal panel - Full width -->
                    <div class="relative bg-white rounded-lg shadow-xl" style="width: calc(100vw - 32px); margin: 0 auto;" onclick="event.stopPropagation()">
                    <!-- Header -->
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <span>Search Results</span>
                                <span id="searchResultsCount" class="ml-2 text-sm font-normal text-gray-500"></span>
                            </h3>
                            <button onclick="closeSearchModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <!-- Filters -->
                        <div id="searchFilters" class="mt-4 flex flex-wrap gap-2">
                            <button class="filter-chip active" data-filter-type="stage" data-filter-value="all">All Stages</button>
                            <button class="filter-chip" data-filter-type="stage" data-filter-value="WS 1.0/Pre-Registration">TOFU</button>
                            <button class="filter-chip" data-filter-type="stage" data-filter-value="WS 1.0/Trial">MOFU</button>
                            <button class="filter-chip" data-filter-type="stage" data-filter-value="WS 1.0/Success_Client">BOFU</button>
                            <button class="filter-chip" data-filter-type="stage" data-filter-value="WS 2.0 Release">Release</button>
                            <span class="mx-2 text-gray-300">|</span>
                            <button class="filter-chip active" data-filter-type="content_type" data-filter-value="all">All Types</button>
                            <button class="filter-chip" data-filter-type="content_type" data-filter-value="Articles">Articles</button>
                            <button class="filter-chip" data-filter-type="content_type" data-filter-value="Videos">Videos</button>
                            <button class="filter-chip" data-filter-type="content_type" data-filter-value="Lead Magnets">Lead Magnets</button>
                        </div>
                    </div>

                    <!-- Content - split layout -->
                    <div class="flex" style="height: 70vh;">
                        <!-- Results list (left) -->
                        <div class="w-2/5 overflow-y-auto border-r border-gray-200">
                            <div id="searchResultsList" class="divide-y divide-gray-200">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Preview panel (right) -->
                        <div class="w-3/5 overflow-y-auto bg-gray-50">
                            <div id="searchPreviewPanel" class="p-6">
                                <div class="text-center text-gray-400 py-12">
                                    <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p class="mt-2 text-sm">Select a file to preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fullscreen Tree View -->
        <div id="fullscreenTreeView" class="hidden fixed inset-0 z-50 bg-gray-900">
            <!-- Header Bar -->
            <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-bold text-white">–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–µ—Ä–µ–≤–∞ –∫–æ–Ω—Ç–µ–Ω—Ç—É</h2>

                        <!-- Stage Selector -->
                        <select id="fullscreenTreeStageSelect" class="px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <optgroup label="WS 1.0">
                                <option value="WS 1.0/Pre-Registration">Pre-Registration (TOFU)</option>
                                <option value="WS 1.0/Trial">Trial (MOFU)</option>
                                <option value="WS 1.0/Success_Client">Success_Client (BOFU)</option>
                            </optgroup>
                            <option value="WS 2.0 Release">WS 2.0 Release</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-3">
                        <!-- Zoom Controls -->
                        <div class="flex items-center space-x-2 bg-gray-700 rounded-lg px-3 py-2">
                            <button onclick="zoomOut()" class="text-white hover:text-orange-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
                                </svg>
                            </button>
                            <span class="text-white text-sm font-medium w-16 text-center" id="zoomLevel">100%</span>
                            <button onclick="zoomIn()" class="text-white hover:text-orange-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                                </svg>
                            </button>
                            <button onclick="resetZoom()" class="text-white hover:text-orange-400 transition-colors ml-2 text-xs">
                                –°–∫–∏–Ω—É—Ç–∏
                            </button>
                        </div>

                        <!-- Expand/Collapse Controls -->
                        <button onclick="expandAllNodesFullscreen()" class="px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-medium flex items-center space-x-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å–µ</span>
                        </button>
                        <button onclick="collapseAllNodesFullscreen()" class="px-3 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm font-medium flex items-center space-x-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                            </svg>
                            <span>–ó–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å–µ</span>
                        </button>

                        <!-- Close Button -->
                        <button onclick="toggleTreeView()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            <span>–ó–∞–∫—Ä–∏—Ç–∏</span>
                        </button>
                    </div>
                </div>

                <!-- Legend -->
                <div class="mt-3 flex items-center space-x-6 text-sm">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-gray-300">–Ñ –∫–æ–Ω—Ç–µ–Ω—Ç (‚úÖ)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-gray-300">–ü–æ—Ä–æ–∂–Ω—è (‚ùå)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                        <span class="text-gray-300">–û—á—ñ–∫—É–≤–∞–Ω–æ –ø–æ—Ä–æ–∂–Ω—è (üü°)</span>
                    </div>
                    <div class="ml-auto text-xs text-gray-400">
                        <span class="font-semibold">–ü—ñ–¥–∫–∞–∑–∫–∞:</span> –ö–ª—ñ–∫–∞–π—Ç–µ –≤—É–∑–ª–∏ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è ‚Ä¢ –ö–æ–ª–µ—Å–æ –º–∏—à—ñ –¥–ª—è –º–∞—Å—à—Ç–∞–±—É ‚Ä¢ –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è
                    </div>
                </div>
            </div>

            <!-- SVG Container -->
            <div id="fullscreenTreeContainer" class="w-full bg-gray-900" style="height: calc(100vh - 140px);">
                <svg id="fullscreenTreeSvg" class="w-full h-full"></svg>
            </div>
        </div>

        <!-- Folder Explorer Modal -->
        <div id="folderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="navigateBack()" id="backBtn" class="text-gray-400 hover:text-gray-600 disabled:opacity-30" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">Folder Explorer</h3>
                            <p class="text-xs text-gray-500" id="modalPath"></p>
                        </div>
                    </div>
                    <button onclick="closeFolderModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto px-6 py-4">
                    <div id="folderContent">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-gray-600">
                            <span class="font-medium" id="modalFileCount">0</span> —Ñ–∞–π–ª—ñ–≤ —É —Ü—ñ–π –ø–∞–ø—Ü—ñ
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-500" id="modalEmptyCount">0 –ø–æ—Ä–æ–∂–Ω—ñ—Ö –ø–∞–ø–æ–∫</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-12">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex items-center justify-between">
                    <p class="text-sm text-gray-500">¬© 2025 Worksection Content Tree Project</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                        <span>Powered by Claude Code</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Global variables for charts
        let contentTypeChart = null;
        let statusChart = null;
        let dashboardData = null;
        let searchIndex = [];
        let currentSearchResults = [];
        let selectedResultId = null;
        let activeFilters = {
            stage: 'all',
            content_type: 'all'
        };

        // Load dashboard data
        async function loadData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('data.json not found. Please run: python update_dashboard.py');
                }
                dashboardData = await response.json();
                searchIndex = dashboardData.search_index || [];
                console.log(`Search index loaded: ${searchIndex.length} files`);
                updateDashboard(dashboardData);
                initializeSearch();
                initializeTreeView();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ. –ó–∞–ø—É—Å—Ç—ñ—Ç—å: python update_dashboard.py');
            }
        }

        // Update all dashboard sections
        function updateDashboard(data) {
            updateMetrics(data);
            updateStages(data);
            updateCharts(data);
            updateLanguages(data);
            updateRecentActivity(data);
            updateGapsTable(data);
        }

        // Update key metrics
        function updateMetrics(data) {
            const meta = data.metadata;

            // Card 1: Total files with WS 1.0 / WS 2.0 breakdown
            document.getElementById('totalContent').textContent = meta.total_files;
            document.getElementById('ws10Count').textContent = meta.published_count || 0;
            document.getElementById('ws20Count').textContent = meta.not_published_count || 0;

            // Card 2: Published (WS 1.0)
            const published = meta.published_count || 0;
            document.getElementById('publishedContent').textContent = published;
            document.getElementById('weekGrowth').textContent = data.growth_trend.last_week;

            // Card 3: Not Published (WS 2.0 Release)
            const notPublished = meta.not_published_count || 0;
            document.getElementById('notPublishedContent').textContent = notPublished;

            // Card 4: Growth
            document.getElementById('monthGrowth').textContent = data.growth_trend.last_month;
            document.getElementById('weeklyAvg').textContent = data.growth_trend.weekly_avg;

            // Update timestamp
            const date = new Date(meta.last_update);
            document.getElementById('lastUpdate').textContent = date.toLocaleString('uk-UA', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Update stages section - show all main sections (Features, Pains, Business_Types, etc)
        function updateStages(data) {
            const container = document.getElementById('stagesContainer');
            const stages = [
                { name: 'WS 1.0/Pre-Registration', label: 'TOFU', color: 'blue' },
                { name: 'WS 1.0/Trial', label: 'MOFU', color: 'yellow' },
                { name: 'WS 1.0/Success_Client', label: 'BOFU', color: 'green' },
                { name: 'WS 2.0 Release', label: 'RELEASE', color: 'purple' }
            ];

            container.innerHTML = stages.map(stage => {
                const stageData = data.stages_detail[stage.name] || {};
                const total = data.by_stage[stage.name] || 0;
                const fillRate = stageData.fill_rate || 0;
                const emptyCount = stageData.empty_folders_count || 0;

                // WS 1.0: show all expected sections (even empty), WS 2.0: show actual data
                let sections;
                if (stage.name.startsWith('WS 2.0')) {
                    // WS 2.0: show only what exists
                    sections = Object.entries(stageData.by_section || {});
                } else {
                    // WS 1.0: show all expected sections
                    const expectedSections = ['Features', 'Business_Types', 'Competitors', 'Pains', 'PM_Education'];
                    const bySection = stageData.by_section || {};
                    sections = expectedSections.map(section => [section, bySection[section] || 0]);
                }

                return `
                    <div class="space-y-4 min-h-[280px] flex flex-col">
                        <div class="flex items-center justify-between">
                            <button onclick="openFolderExplorer('${stage.name}')" class="font-medium text-gray-900 hover:text-blue-600 transition-colors flex items-center space-x-1">
                                <span>${stage.name.replace('_', ' ')}</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </button>
                            <span class="text-xs bg-${stage.color}-100 text-${stage.color}-700 px-2 py-1 rounded">${stage.label}</span>
                        </div>
                        <div class="space-y-2 flex-1">
                            ${sections.map(([section, count]) => {
                                // Use section_progress for WS 2.0, fallback to estimate for WS 1.0
                                const sectionProgress = stageData.section_progress?.[section];
                                let percentage, required;
                                if (sectionProgress) {
                                    percentage = sectionProgress.fill_rate;
                                    required = sectionProgress.required;
                                } else {
                                    // WS 1.0: estimate based on section type
                                    const estimates = {
                                        'Features': 100, 'Business_Types': 50, 'Competitors': 30,
                                        'Pains': 30, 'PM_Education': 40
                                    };
                                    required = estimates[section] || 50;
                                    percentage = Math.min(100, (count / required) * 100);
                                }
                                const barColor = percentage >= 100 ? 'green' : percentage >= 70 ? stage.color : percentage >= 40 ? 'yellow' : 'red';
                                return `
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-600 truncate flex-1">${section}</span>
                                    <div class="flex items-center space-x-2 ml-2">
                                        <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                            <div class="bg-${barColor}-500 h-1.5 rounded-full" style="width: ${Math.min(100, percentage)}%"></div>
                                        </div>
                                        <span class="font-medium text-gray-700 w-8 text-right">${count}/${required}</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <div class="pt-3 border-t space-y-2 mt-auto">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700">Total</span>
                                <span class="text-sm font-bold text-gray-900">${total}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">Filled</span>
                                <span class="text-xs font-medium text-${stage.color}-600">${fillRate}%</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">Empty folders</span>
                                <span class="text-xs font-medium text-red-600">${emptyCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update charts
        function updateCharts(data) {
            // Content Type Chart
            const contentTypes = data.by_content_type;
            const typeLabels = Object.keys(contentTypes);
            const typeData = Object.values(contentTypes);
            const typeColors = [
                'rgb(59, 130, 246)',   // Landings - —Å–∏–Ω—ñ–π
                'rgb(34, 197, 94)',    // Articles - –∑–µ–ª–µ–Ω–∏–π
                'rgb(234, 179, 8)',    // Videos - –∂–æ–≤—Ç–∏–π
                'rgb(168, 85, 247)',   // Static Ads - —Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π
                'rgb(236, 72, 153)',   // Ads - —Ä–æ–∂–µ–≤–∏–π
                'rgb(251, 146, 60)',   // Other - –æ—Ä–∞–Ω–∂–µ–≤–∏–π
                'rgb(14, 165, 233)',   // Lead Magnets - –±–ª–∞–∫–∏—Ç–Ω–∏–π
                'rgb(244, 63, 94)'     // SMM - —á–µ—Ä–≤–æ–Ω–∏–π
            ];

            if (contentTypeChart) contentTypeChart.destroy();
            const ctx1 = document.getElementById('contentTypeChart').getContext('2d');
            contentTypeChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: typeData,
                        backgroundColor: typeColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Update legend
            const legendHtml = typeLabels.map((label, i) => `
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${typeColors[i]}"></div>
                    <span class="text-sm text-gray-600">${label} (${typeData[i]})</span>
                </div>
            `).join('');
            document.getElementById('contentTypeLegend').innerHTML = legendHtml;

            // Status Chart - Published, Not Published, Planned
            const meta = data.metadata;
            const publishedCount = meta.published_count || 0;
            const notPublishedCount = meta.not_published_count || 0;
            const plannedCount = meta.empty_folders || 0;

            const statusLabels = ['–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ', '–ù–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ', '–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ'];
            const statusData = [publishedCount, notPublishedCount, plannedCount];
            const statusColors = ['rgb(34, 197, 94)', 'rgb(251, 146, 60)', 'rgb(156, 163, 175)'];

            if (statusChart) statusChart.destroy();
            const ctx2 = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusColors,
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Update status legend
            const statusLegendHtml = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: rgb(34, 197, 94)"></div>
                        <span class="text-sm text-gray-600">–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ</span>
                    </div>
                    <span class="text-sm font-medium">${publishedCount}</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: rgb(251, 146, 60)"></div>
                        <span class="text-sm text-gray-600">–ù–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ</span>
                    </div>
                    <span class="text-sm font-medium">${notPublishedCount}</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: rgb(156, 163, 175)"></div>
                        <span class="text-sm text-gray-600">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ</span>
                    </div>
                    <span class="text-sm font-medium">${plannedCount}</span>
                </div>
            `;
            document.getElementById('statusLegend').innerHTML = statusLegendHtml;
        }

        // Update languages
        function updateLanguages(data) {
            const languages = data.by_language;
            const total = Object.values(languages).reduce((a, b) => a + b, 0);

            const html = Object.entries(languages)
                .sort((a, b) => b[1] - a[1])
                .map(([lang, count]) => {
                    const percent = Math.round((count / total) * 100);
                    return `
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">${lang}</span>
                            <div class="flex items-center space-x-2 flex-1 ml-4">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900 w-12 text-right">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('languageList').innerHTML = html;
        }

        // Update recent activity
        function updateRecentActivity(data) {
            const activities = [];

            // Collect recent changes from all stages
            Object.entries(data.stages_detail).forEach(([stage, details]) => {
                (details.recent_changes || []).forEach(file => {
                    activities.push({ ...file, stage });
                });
            });

            // Sort by date and take top 5
            activities.sort((a, b) => new Date(b.modified) - new Date(a.modified));
            const recent = activities.slice(0, 5);

            const html = recent.length > 0 ? recent.map(file => {
                const date = new Date(file.modified);
                const timeAgo = getTimeAgo(date);
                const statusColor = file.status === 'Published' ? 'green' :
                                   file.status === 'Review' ? 'purple' : 'yellow';

                // Find driveUrl from search index
                const searchFile = (data.search_index || []).find(
                    f => f.name === file.name && f.stage === file.stage
                );
                const driveUrl = searchFile?.driveUrl || '';

                return `
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-${statusColor}-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-${statusColor}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            ${driveUrl ?
                                `<a href="${driveUrl}" target="_blank" class="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline truncate block">${file.name}</a>` :
                                `<p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>`
                            }
                            <p class="text-xs text-gray-500 mt-1">${file.stage} / ${file.section}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <p class="text-xs text-gray-400">${timeAgo} ‚Ä¢ ${file.status}</p>
                                ${driveUrl ? `
                                    <a href="${driveUrl}" target="_blank" class="text-green-600 hover:text-green-800" title="Open in Google Drive">
                                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M7.71 3.5L1.15 15l3.43 6 6.56-11.5-3.43-6zm1.14 0L15.41 15H8.29L1.73 3.5h7.12zm7.72 0L23 15l-3.43 6-6.56-11.5 3.56-6zm-.57 12L22.56 3.5h-7.12L8.88 15.5h7.12z"/>
                                        </svg>
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-sm text-gray-500">–ù–µ–º–∞—î –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –∑–º—ñ–Ω</p>';

            document.getElementById('recentActivity').innerHTML = html;
        }

        // Update gaps tables - split by WS 1.0 and WS 2.0
        function updateGapsTable(data) {
            const allGaps = data.gaps || [];

            // Split gaps by WS version
            const ws10Gaps = allGaps.filter(g => g.stage && g.stage.startsWith('WS 1.0'));
            const ws20Gaps = allGaps.filter(g => g.stage && g.stage.startsWith('WS 2.0'));

            // Update counts
            document.getElementById('ws10GapsCount').textContent = ws10Gaps.length;
            document.getElementById('ws20GapsCount').textContent = ws20Gaps.length;

            // Render WS 1.0 gaps
            document.getElementById('gapsTableWs10').innerHTML = renderGapRows(ws10Gaps.slice(0, 15));

            // Render WS 2.0 gaps
            document.getElementById('gapsTableWs20').innerHTML = renderGapRows(ws20Gaps.slice(0, 15));
        }

        function renderGapRows(gaps) {
            if (!gaps || gaps.length === 0) {
                return '<tr><td colspan="3" class="px-3 py-4 text-center text-sm text-gray-500">–ù–µ–º–∞—î –ø—Ä–æ–≥–∞–ª–∏–Ω</td></tr>';
            }

            return gaps.map(gap => {
                const severityColors = {
                    'critical': 'red',
                    'high': 'orange',
                    'medium': 'yellow',
                    'low': 'gray'
                };
                const color = severityColors[gap.severity] || 'gray';
                const priorityScore = gap.priority_score || 0;
                const currentCount = gap.current_count || 0;
                const idealCount = gap.ideal_count || 3;

                // Get section name (last part of path)
                const pathParts = (gap.path || '').split('/');
                const sectionName = pathParts.pop() || 'Unknown';
                const parentPath = pathParts.slice(1).join(' ‚Ä∫ '); // Skip WS 1.0/ or WS 2.0

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 text-sm">
                            <div class="font-medium text-gray-900">${sectionName}</div>
                            <div class="text-xs text-gray-500">${parentPath}</div>
                            <div class="text-xs text-${color}-600 mt-1">${gap.content_type || ''}</div>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="text-sm font-bold text-blue-600">${priorityScore}</span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="text-sm font-medium text-gray-700">${currentCount}/${idealCount}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Refresh data
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');

            btn.disabled = true;
            icon.classList.add('animate-spin');

            try {
                const response = await fetch('http://localhost:8080/api/refresh', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    dashboardData = result.data;
                    updateDashboard(dashboardData);

                    // Auto-refresh fullscreen tree if it's open
                    if (fullscreenTreeSvg && !document.getElementById('fullscreenTreeView').classList.contains('hidden')) {
                        const currentStage = document.getElementById('fullscreenTreeStageSelect').value;
                        loadFullscreenTreeStage(currentStage);
                    }

                    console.log('Dashboard updated successfully');
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ' + result.message);
                }
            } catch (error) {
                console.error('Refresh failed:', error);
                alert('–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ.\n\n–ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥–æ—é:\n./start_dashboard.sh\n\n–ü–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏" –∑–Ω–æ–≤—É.');
            } finally {
                btn.disabled = false;
                icon.classList.remove('animate-spin');
            }
        }

        // Folder Explorer functionality
        let folderNavigationStack = [];
        let currentFolderData = null;
        let currentFolderChildren = [];  // Store children for click handling

        function openFolderExplorer(stage, folderPath = null) {
            const stageData = dashboardData.stages_detail[stage];
            if (!stageData || !stageData.folder_tree) {
                alert('Folder tree data not available');
                return;
            }

            folderNavigationStack = [];

            if (folderPath) {
                // Navigate to specific folder in tree
                currentFolderData = findFolderInTree(stageData.folder_tree, folderPath);
            } else {
                // Start at root of stage
                currentFolderData = stageData.folder_tree;
            }

            if (!currentFolderData) {
                alert('Folder not found');
                return;
            }

            renderFolderContent(stage);
            document.getElementById('folderModal').classList.remove('hidden');
        }

        function findFolderInTree(tree, path) {
            if (tree.path === path || tree.name === path) {
                return tree;
            }

            for (const child of tree.children) {
                const found = findFolderInTree(child, path);
                if (found) return found;
            }

            return null;
        }

        function renderFolderContent(stage) {
            if (!currentFolderData) return;

            // Update header
            document.getElementById('modalTitle').textContent = currentFolderData.name || 'Root';
            document.getElementById('modalPath').textContent = `${stage} / ${currentFolderData.path || ''}`;

            // Update footer stats
            const emptyChildren = currentFolderData.children.filter(c => c.is_empty).length;
            document.getElementById('modalFileCount').textContent = currentFolderData.file_count;
            document.getElementById('modalEmptyCount').textContent = emptyChildren;

            // Enable/disable back button
            document.getElementById('backBtn').disabled = folderNavigationStack.length === 0;

            // Render subfolders
            const content = document.getElementById('folderContent');

            if (currentFolderData.children.length === 0 && currentFolderData.files.length === 0) {
                content.innerHTML = '<div class="text-center py-12 text-gray-500">–ü–æ—Ä–æ–∂–Ω—è –ø–∞–ø–∫–∞</div>';
                return;
            }

            let html = '';

            // Show subfolders
            if (currentFolderData.children.length > 0) {
                html += '<div class="mb-6"><h4 class="text-sm font-semibold text-gray-700 mb-3">üìÅ –ü—ñ–¥–ø–∞–ø–∫–∏</h4><div class="grid grid-cols-1 gap-2">';

                // Store sorted children for click handling
                currentFolderChildren = [...currentFolderData.children].sort((a, b) => b.file_count - a.file_count);

                currentFolderChildren.forEach((child, index) => {
                        const isEmpty = child.is_empty;
                        const emptyClass = isEmpty ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200';
                        const textClass = isEmpty ? 'text-red-600' : 'text-gray-900';

                        html += `
                            <button onclick="navigateToFolderByIndex(${index})"
                                    class="flex items-center justify-between p-3 border ${emptyClass} rounded-lg hover:shadow-md transition-all text-left">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5 ${isEmpty ? 'text-red-400' : 'text-blue-500'}" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                    </svg>
                                    <span class="font-medium ${textClass}">${child.name}</span>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <span class="text-sm ${isEmpty ? 'text-red-500' : 'text-gray-500'}">${child.file_count} —Ñ–∞–π–ª—ñ–≤</span>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </div>
                            </button>
                        `;
                    });

                html += '</div></div>';
            }

            // Show files in this folder
            if (currentFolderData.files.length > 0) {
                html += '<div><h4 class="text-sm font-semibold text-gray-700 mb-3">üìÑ –§–∞–π–ª–∏ –≤ —Ü—ñ–π –ø–∞–ø—Ü—ñ</h4><div class="space-y-1">';

                currentFolderData.files
                    .sort((a, b) => new Date(b.modified) - new Date(a.modified))
                    .forEach(file => {
                        const date = new Date(file.modified);
                        const dateStr = date.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });

                        // Get driveUrl from search index if available
                        const searchFile = (dashboardData.search_index || []).find(
                            f => f.name === file.name && f.path.includes(currentFolderData.path)
                        );
                        const driveUrl = searchFile?.driveUrl || '';

                        html += `
                            <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                    </svg>
                                    ${driveUrl ?
                                        `<a href="${driveUrl}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">${file.name}</a>` :
                                        `<span class="text-sm text-gray-700">${file.name}</span>`
                                    }
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${driveUrl ? `
                                        <a href="${driveUrl}" target="_blank" class="text-green-600 hover:text-green-800" title="Open in Google Drive">
                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M7.71 3.5L1.15 15l3.43 6 6.56-11.5-3.43-6zm1.14 0L15.41 15H8.29L1.73 3.5h7.12zm7.72 0L23 15l-3.43 6-6.56-11.5 3.56-6zm-.57 12L22.56 3.5h-7.12L8.88 15.5h7.12z"/>
                                            </svg>
                                        </a>
                                    ` : ''}
                                    <span class="text-xs text-gray-500">${dateStr}</span>
                                </div>
                            </div>
                        `;
                    });

                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        function navigateToFolderByIndex(index) {
            if (index >= 0 && index < currentFolderChildren.length) {
                navigateToFolder(currentFolderChildren[index]);
            }
        }

        function navigateToFolder(folderData) {
            folderNavigationStack.push(currentFolderData);
            currentFolderData = folderData;

            const stage = document.getElementById('modalPath').textContent.split(' / ')[0];
            renderFolderContent(stage);
        }

        function navigateBack() {
            if (folderNavigationStack.length > 0) {
                currentFolderData = folderNavigationStack.pop();
                const stage = document.getElementById('modalPath').textContent.split(' / ')[0];
                renderFolderContent(stage);
            }
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.add('hidden');
            folderNavigationStack = [];
            currentFolderData = null;
        }

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFolderModal();
            }
        });

        // Close modal on background click
        document.getElementById('folderModal').addEventListener('click', (e) => {
            if (e.target.id === 'folderModal') {
                closeFolderModal();
            }
        });

        // Show gaps modal
        function showGaps() {
            if (!dashboardData) return;
            const criticalGaps = dashboardData.gaps.filter(g => g.severity === 'critical');
            const message = criticalGaps.length > 0
                ? '–ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–≥–∞–ª–∏–Ω–∏:\n\n' + criticalGaps.map((g, i) => `${i + 1}. ${g.path} (${g.files} —Ñ–∞–π–ª—ñ–≤)`).join('\n')
                : '–ù–µ–º–∞—î –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–≥–∞–ª–∏–Ω!';
            alert(message);
        }

        // Helper: get time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                '—Ä—ñ–∫': 31536000,
                '–º—ñ—Å—è—Ü—å': 2592000,
                '—Ç–∏–∂–¥–µ–Ω—å': 604800,
                '–¥–µ–Ω—å': 86400,
                '–≥–æ–¥–∏–Ω—É': 3600,
                '—Ö–≤–∏–ª–∏–Ω—É': 60
            };

            for (const [name, secondsInInterval] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInInterval);
                if (interval >= 1) {
                    return `${interval} ${name} —Ç–æ–º—É`;
                }
            }
            return '—â–æ–π–Ω–æ';
        }

        // Show error
        function showError(message) {
            document.body.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-50">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</h3>
                        <p class="mt-1 text-sm text-gray-500">${message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== SEARCH FUNCTIONALITY =====

        function initializeSearch() {
            const searchInput = document.getElementById('globalSearch');
            const searchSuggestions = document.getElementById('searchSuggestions');

            // Handle search input
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                if (query.length < 2) {
                    searchSuggestions.classList.add('hidden');
                    return;
                }

                // Debounced search
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 200);
            });

            // Handle Enter key - open full modal
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        openSearchModal(query);
                    }
                }
                if (e.key === 'Escape') {
                    searchSuggestions.classList.add('hidden');
                }
            });

            // Close suggestions on click outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                    searchSuggestions.classList.add('hidden');
                }
            });

            // Keyboard shortcut: Cmd+K / Ctrl+K
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });

            // Initialize filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const filterType = chip.dataset.filterType;
                    const filterValue = chip.dataset.filterValue;

                    // Toggle active state
                    document.querySelectorAll(`.filter-chip[data-filter-type="${filterType}"]`).forEach(c => {
                        c.classList.remove('active');
                    });
                    chip.classList.add('active');

                    // Update filters
                    activeFilters[filterType] = filterValue;

                    // Reapply search with new filters
                    applyFilters();
                });
            });
        }

        function performSearch(query) {
            if (!query || query.length < 2) return;

            const results = instantSearch(query);

            // Show top 5 suggestions
            const suggestions = results.slice(0, 5);
            displaySuggestions(suggestions, query);
        }

        function instantSearch(query) {
            const queryLower = query.toLowerCase();
            const words = queryLower.split(/\s+/);

            const results = searchIndex.map(file => {
                let score = 0;
                const searchFields = [
                    file.name,
                    file.display_name,
                    file.feature,
                    ...(file.keywords || [])
                ].join(' ').toLowerCase();

                // Exact match in title
                if (file.display_name.toLowerCase().includes(queryLower)) {
                    score += 100;
                }

                // Partial match in title
                if (file.name.toLowerCase().includes(queryLower)) {
                    score += 70;
                }

                // Match in keywords
                const matchedKeywords = (file.keywords || []).filter(k =>
                    words.some(w => k.includes(w))
                );
                score += matchedKeywords.length * 30;

                // Match in feature/section
                if (file.feature && file.feature.toLowerCase().includes(queryLower)) {
                    score += 20;
                }

                // Match any word
                words.forEach(word => {
                    if (searchFields.includes(word)) {
                        score += 10;
                    }
                });

                // Boost recent files
                if (file.modified) {
                    const modified = new Date(file.modified);
                    const now = new Date();
                    const daysDiff = (now - modified) / (1000 * 60 * 60 * 24);
                    if (daysDiff < 7) score += 10;
                }

                // Boost published status
                if (file.status === 'Published') {
                    score += 5;
                }

                return { ...file, relevance_score: score };
            }).filter(f => f.relevance_score > 0);

            return results.sort((a, b) => b.relevance_score - a.relevance_score);
        }

        function displaySuggestions(suggestions, query) {
            const container = document.getElementById('searchSuggestions');

            if (suggestions.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500 text-sm">
                        No results found for "${query}"
                    </div>
                `;
                container.classList.remove('hidden');
                return;
            }

            container.innerHTML = suggestions.map(result => `
                <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0"
                     onclick="selectFile('${result.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">
                                ${highlightMatches(result.display_name, query)}
                            </h4>
                            <p class="text-xs text-gray-500 mt-1">
                                ${result.stage} / ${result.section}
                            </p>
                        </div>
                        <div class="flex items-center space-x-1 ml-2">
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${result.content_type}</span>
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${result.language}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            container.classList.remove('hidden');
        }

        function highlightMatches(text, query) {
            if (!query) return text;

            const words = query.toLowerCase().split(/\s+/);
            let highlighted = text;

            words.forEach(word => {
                const regex = new RegExp(`(${word})`, 'gi');
                highlighted = highlighted.replace(regex, '<mark>$1</mark>');
            });

            return highlighted;
        }

        function openSearchModal(query) {
            const modal = document.getElementById('searchResultsModal');
            const searchInput = document.getElementById('globalSearch');

            // Hide suggestions
            document.getElementById('searchSuggestions').classList.add('hidden');

            // Perform search
            currentSearchResults = instantSearch(query || searchInput.value);

            // Apply filters
            applyFilters();

            // Show modal
            modal.classList.remove('hidden');
        }

        function closeSearchModal() {
            const modal = document.getElementById('searchResultsModal');
            modal.classList.add('hidden');
            selectedResultId = null;
        }

        function applyFilters() {
            let filtered = currentSearchResults;

            // Apply stage filter
            if (activeFilters.stage !== 'all') {
                filtered = filtered.filter(r => r.stage === activeFilters.stage);
            }

            // Apply content type filter
            if (activeFilters.content_type !== 'all') {
                filtered = filtered.filter(r => r.content_type === activeFilters.content_type);
            }

            displayResults(filtered);
        }

        function displayResults(results) {
            const container = document.getElementById('searchResultsList');
            const countEl = document.getElementById('searchResultsCount');
            const query = document.getElementById('globalSearch').value;

            countEl.textContent = `(${results.length} results)`;

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="mt-2">No files match your filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="search-result-item ${selectedResultId === result.id ? 'selected' : ''}"
                     onclick="selectResult('${result.id}')">
                    <div class="flex items-start justify-between">
                        <h4 class="text-sm font-semibold text-gray-900 mb-1 flex-1">
                            ${highlightMatches(result.display_name, query)}
                        </h4>
                        ${result.driveUrl ? `
                            <a href="${result.driveUrl}" target="_blank" onclick="event.stopPropagation()"
                               class="ml-2 text-green-600 hover:text-green-800" title="Open in Google Drive">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7.71 3.5L1.15 15l3.43 6 6.56-11.5-3.43-6zm1.14 0L15.41 15H8.29L1.73 3.5h7.12zm7.72 0L23 15l-3.43 6-6.56-11.5 3.56-6zm-.57 12L22.56 3.5h-7.12L8.88 15.5h7.12z"/>
                                </svg>
                            </a>
                        ` : ''}
                    </div>
                    <p class="text-xs text-gray-500 mb-2">
                        üìç ${result.stage} / ${result.section} / ${result.feature}
                    </p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${result.content_type}</span>
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${result.language}</span>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">${result.status}</span>
                        <span class="text-xs text-gray-400">${formatFileSize(result.size)}</span>
                    </div>
                </div>
            `).join('');

            // Auto-select first result
            if (results.length > 0 && !selectedResultId) {
                selectResult(results[0].id);
            }
        }

        function selectResult(fileId) {
            selectedResultId = fileId;

            // Update UI
            document.querySelectorAll('.search-result-item').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Show preview
            showFilePreview(fileId);
        }

        function selectFile(fileId) {
            // Close suggestions and open modal with this file
            const file = searchIndex.find(f => f.id === fileId);
            if (file) {
                currentSearchResults = [file];
                openSearchModal();
                selectResult(fileId);
            }
        }

        function showFilePreview(fileId) {
            const file = searchIndex.find(f => f.id === fileId);
            if (!file) return;

            const container = document.getElementById('searchPreviewPanel');

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="border-b border-gray-200 pb-4">
                        <h2 class="text-xl font-bold text-gray-900 mb-2">${file.display_name}</h2>
                        <p class="text-sm text-gray-500">${file.name}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Path</p>
                            <p class="text-sm text-gray-900 font-mono text-xs break-all">${file.path}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Stage</p>
                            <p class="text-sm text-gray-900">${file.stage}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Section</p>
                            <p class="text-sm text-gray-900">${file.section}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Feature</p>
                            <p class="text-sm text-gray-900">${file.feature}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Content Type</p>
                            <p class="text-sm text-gray-900">${file.content_type}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Language</p>
                            <p class="text-sm text-gray-900">${file.language}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Status</p>
                            <p class="text-sm text-gray-900">${file.status}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Modified</p>
                            <p class="text-sm text-gray-900">${formatDate(file.modified)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Size</p>
                            <p class="text-sm text-gray-900">${formatFileSize(file.size)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Keywords</p>
                            <p class="text-sm text-gray-900">${(file.keywords || []).join(', ')}</p>
                        </div>
                    </div>

                    ${file.snippet ? `
                        <div class="bg-gray-100 p-4 rounded border border-gray-200">
                            <p class="text-xs text-gray-500 mb-2">Preview</p>
                            <p class="text-sm text-gray-700">${file.snippet}</p>
                        </div>
                    ` : ''}

                    <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                        <button onclick="openInVSCode('${file.full_path}')"
                                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M23.15 2.587L18.21.21a1.494 1.494 0 0 0-1.705.29l-9.46 8.63-4.12-3.128a.999.999 0 0 0-1.276.057L.327 7.261A1 1 0 0 0 .326 8.74L3.899 12 .326 15.26a1 1 0 0 0 .001 1.479L1.65 17.94a.999.999 0 0 0 1.276.057l4.12-3.128 9.46 8.63a1.492 1.492 0 0 0 1.704.29l4.942-2.377A1.5 1.5 0 0 0 24 20.06V3.939a1.5 1.5 0 0 0-.85-1.352z"/>
                            </svg>
                            <span>Open in VSCode</span>
                        </button>
                        <button onclick="copyPath('${file.full_path}')"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span>Copy Path</span>
                        </button>
                        <button onclick="openInFinder('${file.full_path}')"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                            <span>Show in Finder</span>
                        </button>
                        ${file.driveUrl ? `
                        <a href="${file.driveUrl}" target="_blank"
                           class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center space-x-2">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.71 3.5L1.15 15l3.43 6 6.56-11.5-3.43-6zm1.14 0L15.41 15H8.29L1.73 3.5h7.12zm7.72 0L23 15l-3.43 6-6.56-11.5 3.56-6zm-.57 12L22.56 3.5h-7.12L8.88 15.5h7.12z"/>
                            </svg>
                            <span>Open in Google Drive</span>
                        </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function openInVSCode(path) {
            window.open(`vscode://file${path}`);
        }

        function copyPath(path) {
            navigator.clipboard.writeText(path).then(() => {
                alert('Path copied to clipboard!');
            });
        }

        function openInFinder(path) {
            // This requires server support
            alert('Opening in Finder... (This will be implemented via server API)');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            return date.toLocaleDateString('uk-UA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // ===== FILE PREVIEW FROM TREE =====

        function showFilePreviewFromTree(fileData) {
            // Try to find file in search index for full metadata
            const fileInIndex = searchIndex.find(f =>
                f.full_path === fileData.full_path ||
                f.name === fileData.name
            );

            if (fileInIndex) {
                // Use existing search preview if found
                showFilePreview(fileInIndex.id);
                document.getElementById('searchResultsModal').classList.remove('hidden');
            } else {
                // Show simplified preview from tree data
                const modal = document.getElementById('searchResultsModal');
                const container = document.getElementById('searchPreviewPanel');

                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="border-b border-gray-200 pb-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-2">${fileData.name.replace('.md', '')}</h2>
                            <p class="text-sm text-gray-500">${fileData.name}</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Path</p>
                                <p class="text-sm text-gray-900 font-mono text-xs break-all">${fileData.full_path}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Size</p>
                                <p class="text-sm text-gray-900">${(fileData.file_size / 1024).toFixed(2)} KB</p>
                            </div>
                        </div>

                        <div class="flex space-x-2 mt-4">
                            <button onclick="openInVSCode('${fileData.full_path}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Open in VSCode
                            </button>
                            <button onclick="copyPathToClipboard('${fileData.full_path}')" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                Copy Path
                            </button>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
            }
        }

        // ===== TREE VISUALIZATION =====

        let treeSvg = null;
        let treeRoot = null;
        let currentStage = 'WS 1.0/Pre-Registration';
        let nodeIdCounter = 0;

        function initializeTreeView() {
            if (!dashboardData) return;

            // Setup SVG
            const container = document.getElementById('treeContainer');
            const width = Math.max(container.clientWidth, 2000);  // Min width for horizontal tree
            const height = Math.max(container.clientHeight, 1000);

            const svg = d3.select('#treeSvg')
                .attr('width', width)
                .attr('height', height);

            svg.selectAll('*').remove();  // Clear any existing content

            treeSvg = svg.append('g')
                .attr('transform', 'translate(40,40)');

            // Load initial stage
            loadTreeStage(currentStage);

            // Stage selector handler
            document.getElementById('treeStageSelect').addEventListener('change', (e) => {
                currentStage = e.target.value;
                loadTreeStage(currentStage);
            });
        }

        function loadTreeStage(stageName) {
            const stageDetail = dashboardData.stages_detail[stageName];
            if (!stageDetail || !stageDetail.folder_tree) {
                console.error('No folder_tree data for stage:', stageName);
                return;
            }

            // Transform folder_tree to D3 hierarchy
            const hierarchyData = transformToHierarchy(stageDetail.folder_tree, stageName);

            // Create D3 tree layout
            renderTree(hierarchyData);
        }

        function transformToHierarchy(folderNode, stageName = '') {
            // Transform child folders
            const childFolders = (folderNode.children || []).map(child => transformToHierarchy(child, stageName));

            // Transform files into leaf nodes
            const fileNodes = (folderNode.files || []).map(file => ({
                name: file.name,
                file_count: 0,
                is_empty: false,
                path: folderNode.path || '',
                full_path: `Content/${stageName}/${folderNode.path}/${file.name}`.replace(/\/\//g, '/'),
                is_file: true,  // Mark as file node
                file_size: file.size,
                file_modified: file.modified,
                children: []
            }));

            // Debug log
            if (fileNodes.length > 0) {
                console.log(`Folder ${folderNode.name}: ${fileNodes.length} files added`);
            }

            return {
                name: folderNode.name || 'Unknown',
                file_count: folderNode.file_count || 0,
                is_empty: folderNode.is_empty !== false,
                path: folderNode.path || '',
                is_file: false,  // Mark as folder node
                children: [...childFolders, ...fileNodes]  // Combine folders and files
            };
        }

        function renderTree(data) {
            // Clear previous tree
            treeSvg.selectAll('*').remove();

            // Create hierarchy
            const root = d3.hierarchy(data);

            // Compact layout with dynamic spacing and wider nodes
            const nodeWidth = 300;
            const nodeHeight = 75;  // Increased vertical spacing to prevent overlap

            // Create tree layout (horizontal) with dynamic separation
            const treeLayout = d3.tree()
                .nodeSize([nodeHeight, nodeWidth])
                .separation((a, b) => {
                    const aHasChildren = a.children && a.children.length > 0;
                    const bHasChildren = b.children && b.children.length > 0;

                    if (a.parent === b.parent) {
                        if (!aHasChildren && !bHasChildren) return 1.0;  // Minimum spacing
                        return 1.2;
                    }
                    return 1.3;
                });

            treeLayout(root);

            // Initially collapse all nodes (only root visible)
            root.descendants().forEach(d => {
                d.id = ++nodeIdCounter;

                // Collapse all nodes except the root node
                if (d.depth > 0 && !d.data.is_file && d.children) {
                    d._children = d.children;
                    d.children = null;
                }

                d.x0 = d.x;
                d.y0 = d.y;
            });

            // Store root
            treeRoot = root;

            // Update visualization
            updateTree(root);
        }

        function updateTree(source) {
            const duration = 300;

            // Recalculate tree layout with current expansion state for dynamic spacing
            const treeLayout = d3.tree()
                .nodeSize([75, 300])  // [vertical, horizontal] - increased vertical spacing
                .separation((a, b) => {
                    const aHasChildren = a.children && a.children.length > 0;
                    const bHasChildren = b.children && b.children.length > 0;

                    if (a.parent === b.parent) {
                        if (!aHasChildren && !bHasChildren) return 1.0;
                        return 1.2;
                    }
                    return 1.3;
                });

            treeLayout(treeRoot);

            const nodes = treeRoot.descendants();
            const links = treeRoot.links();

            // Normalize for fixed-depth with more spacing for wider containers
            nodes.forEach(d => { d.y = d.depth * 300; });

            // ========== NODES ==========

            const node = treeSvg.selectAll('g.node')
                .data(nodes, d => d.id);

            // Enter new nodes
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${source.y0 || 0},${source.x0 || 0})`)
                .style('cursor', d => (d.children || d._children) ? 'pointer' : 'default')
                .on('click', (event, d) => {
                    if (d.children || d._children) {
                        toggleNode(event, d);
                    }
                });

            // Add rectangles for nodes - wider to fit full text
            nodeEnter.append('rect')
                .attr('width', 260)
                .attr('height', 60)
                .attr('x', -130)
                .attr('y', -30)
                .attr('rx', 10)
                .attr('fill', '#fff')
                .attr('stroke', d => getNodeColor(d))
                .attr('stroke-width', 3);

            // Add node labels - longer text without truncation
            nodeEnter.append('text')
                .attr('dy', -8)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', '600')
                .style('fill', '#374151')
                .text(d => truncateText(d.data.name, 32));

            // Add file count
            nodeEnter.append('text')
                .attr('dy', 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '11px')
                .style('fill', '#6b7280')
                .text(d => `üìÑ ${d.data.file_count} files`);

            // Add folder progress indicator
            nodeEnter.append('text')
                .attr('dy', 20)
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('font-weight', '600')
                .style('fill', d => {
                    const progressText = getFolderProgressText(d);
                    if (!progressText) return '#6b7280';
                    const stats = calculateFolderStats(d);
                    const percentage = stats.total > 0 ? Math.round((stats.filled / stats.total) * 100) : 0;
                    if (percentage >= 70) return '#10b981';  // Green
                    if (percentage >= 40) return '#f59e0b';  // Orange
                    return '#ef4444';  // Red
                })
                .text(d => getFolderProgressText(d));

            // Add completion status icon (only for depth >= 2)
            nodeEnter.append('text')
                .attr('dy', -12)
                .attr('dx', 115)
                .style('font-size', '18px')
                .text(d => getCompletionIcon(d));

            // Add expand/collapse indicator
            nodeEnter.append('circle')
                .attr('cx', 100)
                .attr('cy', 0)
                .attr('r', 10)
                .attr('fill', '#2563eb')
                .style('display', d => (d.children || d._children) ? 'block' : 'none');

            nodeEnter.append('text')
                .attr('dx', 95)
                .attr('dy', 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '14px')
                .style('font-weight', 'bold')
                .style('fill', '#fff')
                .style('pointer-events', 'none')
                .text(d => {
                    if (!d.children && !d._children) return '';
                    return d.children ? '‚àí' : '+';
                });

            // Update existing nodes
            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(duration)
                .attr('transform', d => `translate(${d.y},${d.x})`);

            nodeUpdate.select('rect')
                .attr('stroke', d => getNodeColor(d));

            nodeUpdate.select('circle')
                .style('display', d => (d.children || d._children) ? 'block' : 'none');

            nodeUpdate.selectAll('text').filter(function() {
                const text = d3.select(this).text();
                return text === '+' || text === '‚àí';
            }).text(d => {
                if (!d.children && !d._children) return '';
                return d.children ? '‚àí' : '+';
            });

            // Exit old nodes
            node.exit()
                .transition()
                .duration(duration)
                .attr('transform', d => `translate(${source.y},${source.x})`)
                .style('opacity', 0)
                .remove();

            // ========== LINKS ==========

            const link = treeSvg.selectAll('path.link')
                .data(links, d => d.target.id);

            // Enter new links
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('fill', 'none')
                .attr('stroke', '#FF8C42')  // Orange branches
                .attr('stroke-width', 2.5)
                .attr('d', d => {
                    const o = {x: source.x0 || 0, y: source.y0 || 0};
                    return diagonal(o, o);
                });

            // Update existing links
            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(duration)
                .attr('d', d => diagonal(d.source, d.target));

            // Exit old links
            link.exit()
                .transition()
                .duration(duration)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .style('opacity', 0)
                .remove();

            // Store old positions
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Diagonal path generator (curved lines)
        function diagonal(s, d) {
            return `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`;
        }

        function getNodeColor(node) {
            const fileCount = node.data.file_count || 0;
            const isEmpty = node.data.is_empty;

            if (fileCount > 0) return '#10b981';  // Green - has content
            if (isEmpty) return '#fbbf24';        // Yellow - expected empty
            return '#ef4444';                      // Red - missing content
        }

        function getCompletionIcon(node) {
            // Show icons only from depth 2+ (Features level and deeper)
            // Depth 0: Stage, Depth 1: Section, Depth 2+: Features/Content
            if (node.depth < 2) return '';

            const fileCount = node.data.file_count || 0;
            const isEmpty = node.data.is_empty;

            // Green checkmark ONLY if has files
            if (fileCount > 0) return '‚úÖ';

            // Yellow if marked as expected empty
            if (isEmpty) return 'üü°';

            // Red X if empty and not marked as expected
            return '‚ùå';
        }

        function calculateFolderStats(node) {
            // Calculate filled/empty folders recursively for a node
            let filled = 0;
            let empty = 0;

            function countFolders(n) {
                // Only count actual folder nodes (not the root node itself)
                if (n.data && n.data.file_count !== undefined) {
                    if (n.data.file_count > 0) {
                        filled++;
                    } else if (!n.data.is_empty) {
                        empty++;
                    }
                }

                // Recurse through all children (both expanded and collapsed)
                const children = n.children || n._children;
                if (children) {
                    children.forEach(child => countFolders(child));
                }
            }

            // Count all children (not the node itself)
            const children = node.children || node._children;
            if (children) {
                children.forEach(child => countFolders(child));
            }

            return { filled, empty, total: filled + empty };
        }

        function getFolderProgressText(node) {
            // Don't show for leaf nodes (files or empty folders without children)
            if (!node.children && !node._children) {
                return '';
            }

            const stats = calculateFolderStats(node);

            // Don't show if no folders inside
            if (stats.total === 0) {
                return '';
            }

            const percentage = stats.total > 0 ? Math.round((stats.filled / stats.total) * 100) : 0;

            // Choose icon based on percentage
            let icon = 'üìÅ';
            if (percentage >= 70) {
                icon = '‚úÖ';  // Green - good progress
            } else if (percentage >= 40) {
                icon = 'üìÇ';  // Neutral - some progress
            } else {
                icon = '‚ùå';  // Red - low progress
            }

            return `${icon} ${stats.filled}/${stats.total} (${percentage}%)`;
        }

        function toggleNode(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            updateTree(d);
        }

        function expandAllNodes() {
            if (!treeRoot) return;

            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }

            expand(treeRoot);
            updateTree(treeRoot);
        }

        function collapseAllNodes() {
            if (!treeRoot) return;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                }
                if (d._children) {
                    d._children.forEach(collapse);
                }
            }

            if (treeRoot.children) {
                treeRoot.children.forEach(collapse);
            }
            updateTree(treeRoot);
        }

        // Toggle gap card expand/collapse
        function toggleGapCard(cardElement) {
            const details = cardElement.querySelector('.card-details');
            const icon = cardElement.querySelector('.card-expand-icon');

            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle gaps section expand/collapse
        function toggleGapsSection(sectionElement) {
            const content = sectionElement.querySelector('.gaps-section-content');
            const icon = sectionElement.querySelector('.gaps-section-icon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle individual gap row expand/collapse
        function toggleGapRow(rowElement) {
            const detailsRow = rowElement.nextElementSibling;
            const icon = rowElement.querySelector('.gap-row-icon');

            if (detailsRow && detailsRow.classList.contains('gap-details-row')) {
                if (detailsRow.style.display === 'none' || !detailsRow.style.display) {
                    detailsRow.style.display = 'table-row';
                    icon.style.transform = 'rotate(90deg)';
                } else {
                    detailsRow.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        // ============================================
        // FULLSCREEN TREE VIEW
        // ============================================

        let fullscreenTreeSvg = null;
        let fullscreenTreeRoot = null;
        let fullscreenZoom = null;
        let currentZoomLevel = 1.0;

        function toggleTreeView() {
            const fullscreenView = document.getElementById('fullscreenTreeView');
            const isHidden = fullscreenView.classList.contains('hidden');

            if (isHidden) {
                // Show fullscreen tree
                fullscreenView.classList.remove('hidden');

                // Initialize tree if not already done
                if (!fullscreenTreeSvg) {
                    initializeFullscreenTree();
                }
            } else {
                // Hide fullscreen tree
                fullscreenView.classList.add('hidden');
            }
        }

        function initializeFullscreenTree() {
            const container = document.getElementById('fullscreenTreeContainer');
            const svg = d3.select('#fullscreenTreeSvg');

            // Clear any existing content
            svg.selectAll('*').remove();

            const width = container.clientWidth;
            const height = container.clientHeight;

            svg.attr('width', width).attr('height', height);

            // Create main group for tree
            fullscreenTreeSvg = svg.append('g')
                .attr('class', 'tree-group');

            // Setup D3 zoom behavior
            fullscreenZoom = d3.zoom()
                .scaleExtent([0.1, 4])  // Min 10%, Max 400%
                .on('zoom', (event) => {
                    fullscreenTreeSvg.attr('transform', event.transform);
                    currentZoomLevel = event.transform.k;
                    updateZoomDisplay();
                });

            svg.call(fullscreenZoom);

            // Set initial transform (centered)
            const initialTransform = d3.zoomIdentity.translate(100, height / 2).scale(1);
            svg.call(fullscreenZoom.transform, initialTransform);

            // Load initial stage
            const stageSelect = document.getElementById('fullscreenTreeStageSelect');
            loadFullscreenTreeStage(stageSelect.value);

            // Connect stage selector
            stageSelect.addEventListener('change', (e) => {
                loadFullscreenTreeStage(e.target.value);
            });
        }

        function loadFullscreenTreeStage(stage) {
            if (!dashboardData || !dashboardData.stages_detail) {
                console.error('Dashboard data not loaded');
                return;
            }

            const stageData = dashboardData.stages_detail[stage];
            if (!stageData || !stageData.folder_tree) {
                console.error('No folder tree data for stage:', stage);
                return;
            }

            const hierarchyData = transformToHierarchy(stageData.folder_tree, stage);
            renderFullscreenTree(hierarchyData);
        }

        function renderFullscreenTree(data) {
            if (!fullscreenTreeSvg) return;

            // Clear existing tree
            fullscreenTreeSvg.selectAll('*').remove();

            const root = d3.hierarchy(data);

            // Compact layout with dynamic spacing and wider nodes
            const treeLayout = d3.tree()
                .nodeSize([75, 300])  // [vertical, horizontal] - increased vertical to prevent overlap
                .separation((a, b) => {
                    // Dynamic separation based on whether nodes are expanded
                    const aHasChildren = a.children && a.children.length > 0;
                    const bHasChildren = b.children && b.children.length > 0;

                    if (a.parent === b.parent) {
                        // Siblings - minimum spacing to prevent overlap
                        if (!aHasChildren && !bHasChildren) return 1.0;
                        return 1.2;
                    }
                    // Different parents - more space
                    return 1.3;
                });

            treeLayout(root);

            // Initially collapse all nodes (only root visible)
            root.descendants().forEach(d => {
                d.id = ++nodeIdCounter;

                // Collapse all nodes except the root node
                if (d.depth > 0 && !d.data.is_file && d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });

            fullscreenTreeRoot = root;
            updateFullscreenTree(root);
        }

        function updateFullscreenTree(source) {
            if (!fullscreenTreeRoot) return;

            const duration = 300;

            // Recalculate tree layout with current expansion state for dynamic spacing
            const treeLayout = d3.tree()
                .nodeSize([75, 300])  // [vertical, horizontal] - increased vertical spacing
                .separation((a, b) => {
                    const aHasChildren = a.children && a.children.length > 0;
                    const bHasChildren = b.children && b.children.length > 0;

                    if (a.parent === b.parent) {
                        if (!aHasChildren && !bHasChildren) return 1.0;  // Minimum to prevent overlap
                        return 1.2;  // At least one expanded
                    }
                    return 1.3;  // Different parents
                });

            treeLayout(fullscreenTreeRoot);

            const nodes = fullscreenTreeRoot.descendants();
            const links = fullscreenTreeRoot.links();

            // Adjust y position based on depth with more space for wider nodes
            nodes.forEach(d => {
                d.y = d.depth * 300;  // Increased for wider containers
            });

            // ===== UPDATE NODES =====
            const node = fullscreenTreeSvg.selectAll('g.node')
                .data(nodes, d => d.id);

            // Enter new nodes
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${source.y0 || 0},${source.x0 || 0})`)
                .style('cursor', 'pointer')
                .on('click', (event, d) => {
                    // If it's a file node, show preview
                    if (d.data.is_file) {
                        event.stopPropagation();
                        showFilePreviewFromTree(d.data);
                        return;
                    }

                    // Otherwise toggle expand/collapse for folders
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        d.children = d._children;
                        d._children = null;
                    }
                    updateFullscreenTree(d);
                });

            // Node rectangle - different style for files vs folders
            nodeEnter.append('rect')
                .attr('width', d => d.data.is_file ? 240 : 280)
                .attr('height', d => d.data.is_file ? 40 : 60)
                .attr('x', -10)
                .attr('y', d => d.data.is_file ? -20 : -30)
                .attr('rx', 6)
                .attr('fill', d => d.data.is_file ? '#374151' : '#1f2937')
                .attr('stroke', d => d.data.is_file ? '#60a5fa' : getNodeColor(d))
                .attr('stroke-width', d => d.data.is_file ? 2 : 3)
                .style('opacity', 0);

            // File icon for file nodes
            nodeEnter.append('text')
                .attr('dy', 3)
                .attr('x', 0)
                .attr('text-anchor', 'start')
                .attr('font-size', '14px')
                .text(d => d.data.is_file ? 'üìÑ' : '')
                .style('opacity', 0);

            // Node text - longer without heavy truncation
            nodeEnter.append('text')
                .attr('dy', d => d.data.is_file ? 3 : -5)
                .attr('x', d => d.data.is_file ? 20 : 5)
                .attr('text-anchor', 'start')
                .attr('fill', 'white')
                .attr('font-size', d => d.data.is_file ? '11px' : '12px')
                .attr('font-weight', d => d.data.is_file ? '400' : '600')
                .text(d => truncateText(d.data.name, d.data.is_file ? 28 : 34))
                .style('opacity', 0);

            // File count (only for folders)
            nodeEnter.append('text')
                .attr('dy', 10)
                .attr('x', 5)
                .attr('text-anchor', 'start')
                .attr('fill', '#9ca3af')
                .attr('font-size', '11px')
                .text(d => {
                    if (d.data.is_file) return '';  // No file count for files
                    const count = d.data.file_count || 0;
                    const children = d._children ? d._children.length : (d.children ? d.children.length : 0);
                    return `üìÑ ${count} files ${children > 0 ? `‚Ä¢ ${children} folders` : ''}`;
                })
                .style('opacity', 0);

            // Folder progress indicator (only for folders)
            nodeEnter.append('text')
                .attr('dy', 25)
                .attr('x', 5)
                .attr('text-anchor', 'start')
                .attr('font-size', '10px')
                .attr('font-weight', '600')
                .attr('fill', d => {
                    if (d.data.is_file) return '#6b7280';
                    const progressText = getFolderProgressText(d);
                    if (!progressText) return '#6b7280';
                    const stats = calculateFolderStats(d);
                    const percentage = stats.total > 0 ? Math.round((stats.filled / stats.total) * 100) : 0;
                    if (percentage >= 70) return '#10b981';  // Green
                    if (percentage >= 40) return '#f59e0b';  // Orange
                    return '#ef4444';  // Red
                })
                .text(d => d.data.is_file ? '' : getFolderProgressText(d))
                .style('opacity', 0);

            // Completion icon (only for folders with depth >= 2)
            nodeEnter.append('text')
                .attr('dy', -8)
                .attr('x', 255)
                .attr('text-anchor', 'end')
                .attr('font-size', '18px')
                .text(d => d.data.is_file ? '' : getCompletionIcon(d))
                .style('opacity', 0);

            // Expand/collapse indicator (only for folders)
            nodeEnter.append('text')
                .attr('dy', 5)
                .attr('x', 255)
                .attr('text-anchor', 'end')
                .attr('fill', '#6b7280')
                .attr('font-size', '14px')
                .text(d => {
                    if (d.data.is_file) return '';  // No indicator for files
                    if (d._children) return '‚ñ∂';
                    if (d.children) return '‚ñº';
                    return '';
                })
                .style('opacity', 0);

            // Update existing nodes
            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(duration)
                .attr('transform', d => `translate(${d.y},${d.x})`)
                .select('rect')
                .style('opacity', 1);

            nodeUpdate.selectAll('text')
                .transition()
                .duration(duration)
                .style('opacity', 1);

            // Update expand/collapse indicator
            nodeUpdate.select('text:last-child')
                .text(d => {
                    if (d._children) return '‚ñ∂';
                    if (d.children) return '‚ñº';
                    return '';
                });

            // Exit old nodes
            node.exit()
                .transition()
                .duration(duration)
                .attr('transform', d => `translate(${source.y},${source.x})`)
                .style('opacity', 0)
                .remove();

            // ===== UPDATE LINKS =====
            const link = fullscreenTreeSvg.selectAll('path.link')
                .data(links, d => d.target.id);

            // Enter new links
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('fill', 'none')
                .attr('stroke', '#FF8C42')  // Orange branches
                .attr('stroke-width', 2.5)
                .attr('d', d => {
                    const o = {x: source.x0 || 0, y: source.y0 || 0};
                    return diagonal(o, o);
                });

            // Update existing links
            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(duration)
                .attr('d', d => diagonal(d.source, d.target));

            // Exit old links
            link.exit()
                .transition()
                .duration(duration)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .style('opacity', 0)
                .remove();

            // Store old positions
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Zoom Control Functions
        function zoomIn() {
            const svg = d3.select('#fullscreenTreeSvg');
            svg.transition().duration(300).call(fullscreenZoom.scaleBy, 1.3);
        }

        function zoomOut() {
            const svg = d3.select('#fullscreenTreeSvg');
            svg.transition().duration(300).call(fullscreenZoom.scaleBy, 0.7);
        }

        function resetZoom() {
            const container = document.getElementById('fullscreenTreeContainer');
            const svg = d3.select('#fullscreenTreeSvg');
            const height = container.clientHeight;

            const initialTransform = d3.zoomIdentity.translate(100, height / 2).scale(1);
            svg.transition().duration(500).call(fullscreenZoom.transform, initialTransform);
        }

        function updateZoomDisplay() {
            const zoomDisplay = document.getElementById('zoomLevel');
            if (zoomDisplay) {
                zoomDisplay.textContent = Math.round(currentZoomLevel * 100) + '%';
            }
        }

        function expandAllNodesFullscreen() {
            if (!fullscreenTreeRoot) return;

            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }

            expand(fullscreenTreeRoot);
            updateFullscreenTree(fullscreenTreeRoot);
        }

        function collapseAllNodesFullscreen() {
            if (!fullscreenTreeRoot) return;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                }
                if (d._children) {
                    d._children.forEach(collapse);
                }
            }

            if (fullscreenTreeRoot.children) {
                fullscreenTreeRoot.children.forEach(collapse);
            }
            updateFullscreenTree(fullscreenTreeRoot);
        }

        function closeTreeView() {
            document.getElementById('fullscreenTreeView').classList.add('hidden');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
