<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Tree Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-sidebar: #0C0E14; --bg-sidebar-hover: #161923;
            --bg-page: #F2F3F5; --bg-card: #FFFFFF; --bg-card-alt: #F8F9FB; --bg-tree: #0F1117;
            --accent: #FF6B35; --accent-hover: #E85A25;
            --blue: #3B82F6; --green: #10B981; --amber: #F59E0B; --red: #EF4444; --purple: #8B5CF6;
            --text-primary: #111827; --text-secondary: #6B7280; --text-muted: #9CA3AF;
            --text-inverse: #F9FAFB; --text-sidebar: #8B8FA3; --text-sidebar-active: #FFFFFF;
            --border: #E5E7EB; --border-light: #F3F4F6;
            --sp-1: 4px; --sp-2: 8px; --sp-3: 12px; --sp-4: 16px; --sp-5: 20px; --sp-6: 24px;
            --sp-8: 32px; --sp-10: 40px; --sp-12: 48px; --sp-16: 64px;
            --r-sm: 4px; --r-md: 8px; --r-lg: 12px; --r-xl: 16px;
            --sidebar-w: 240px;
        }
        html { font-size: 15px; }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg-page); color: var(--text-primary); display: flex; min-height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; position: fixed; left: 0; top: 0; z-index: 40; }
        .sidebar-brand { padding: var(--sp-6) var(--sp-5); border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sidebar-brand-icon { width: 36px; height: 36px; background: var(--accent); border-radius: var(--r-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--sp-3); }
        .sidebar-brand-icon svg { width: 20px; height: 20px; color: white; }
        .sidebar-brand h1 { font-size: 0.93rem; font-weight: 700; color: var(--text-inverse); letter-spacing: -0.01em; line-height: 1.2; }
        .sidebar-brand p { font-size: 0.7rem; color: var(--text-sidebar); margin-top: 2px; }
        .sidebar-nav { flex: 1; padding: var(--sp-4) var(--sp-3); display: flex; flex-direction: column; gap: var(--sp-1); }
        .sidebar-label { font-size: 0.65rem; font-weight: 600; color: var(--text-sidebar); text-transform: uppercase; letter-spacing: 0.08em; padding: var(--sp-4) var(--sp-3) var(--sp-2); }
        .nav-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-3); border-radius: var(--r-md); color: var(--text-sidebar); font-size: 0.87rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: var(--bg-sidebar-hover); color: var(--text-sidebar-active); }
        .nav-item.active { background: rgba(255,107,53,0.12); color: var(--accent); }
        .nav-item.active .nav-icon { color: var(--accent); }
        .nav-icon { width: 20px; height: 20px; flex-shrink: 0; color: var(--text-sidebar); transition: color 0.15s ease; }
        .nav-badge { margin-left: auto; font-size: 0.68rem; font-weight: 600; background: rgba(255,255,255,0.08); color: var(--text-sidebar); padding: 2px 8px; border-radius: 999px; min-width: 28px; text-align: center; }
        .nav-item.active .nav-badge { background: rgba(255,107,53,0.18); color: var(--accent); }
        .sidebar-footer { padding: var(--sp-4) var(--sp-5); border-top: 1px solid rgba(255,255,255,0.06); }
        .sidebar-stat { display: flex; align-items: baseline; gap: var(--sp-2); margin-bottom: var(--sp-2); }
        .sidebar-stat-value { font-size: 1.4rem; font-weight: 700; color: var(--text-inverse); }
        .sidebar-stat-label { font-size: 0.7rem; color: var(--text-sidebar); }
        .sidebar-stat-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden; }
        .sidebar-stat-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.6s ease; }
        .main { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; height: 100vh; }
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: var(--sp-4) var(--sp-8); display: flex; align-items: center; gap: var(--sp-6); flex-shrink: 0; height: 60px; }
        .search-box { flex: 1; max-width: 480px; position: relative; }
        .search-box input { width: 100%; padding: var(--sp-2) var(--sp-4) var(--sp-2) 40px; border: 1px solid var(--border); border-radius: var(--r-md); font-family: inherit; font-size: 0.87rem; background: var(--bg-card-alt); color: var(--text-primary); outline: none; transition: border-color 0.15s, box-shadow 0.15s; }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,107,53,0.1); }
        .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); }
        .search-kbd { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.65rem; font-weight: 500; color: var(--text-muted); background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 2px 6px; }
        .header-meta { margin-left: auto; display: flex; align-items: center; gap: var(--sp-4); font-size: 0.78rem; color: var(--text-secondary); }
        .header-meta strong { color: var(--text-primary); font-weight: 600; }
        .btn-refresh { display: flex; align-items: center; gap: var(--sp-2); padding: var(--sp-2) var(--sp-4); background: var(--accent); color: white; border: none; border-radius: var(--r-md); font-family: inherit; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background 0.15s; }
        .btn-refresh:hover { background: var(--accent-hover); }
        .btn-refresh svg { width: 16px; height: 16px; }
        .content { flex: 1; overflow-y: auto; padding: var(--sp-8); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--sp-6); margin-bottom: var(--sp-8); }
        .metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-lg); padding: var(--sp-6); transition: box-shadow 0.2s, transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
        .metric-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-4); }
        .metric-icon { width: 40px; height: 40px; border-radius: var(--r-md); display: flex; align-items: center; justify-content: center; }
        .metric-icon svg { width: 20px; height: 20px; }
        .metric-badge { font-size: 0.65rem; font-weight: 600; padding: 3px 10px; border-radius: 999px; }
        .metric-value { font-size: 2rem; font-weight: 700; line-height: 1.1; margin-bottom: var(--sp-1); }
        .metric-label { font-size: 0.8rem; color: var(--text-secondary); }
        .metric-sub { margin-top: var(--sp-3); font-size: 0.75rem; font-weight: 500; display: flex; align-items: center; gap: var(--sp-1); }
        .section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-6); margin-bottom: var(--sp-8); }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-lg); padding: var(--sp-6); }
        .card-title { font-size: 0.93rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--sp-5); }
        .product-section { margin-bottom: var(--sp-8); }
        .product-header { margin-bottom: var(--sp-4); }
        .product-label { display: flex; align-items: center; gap: var(--sp-3); }
        .product-dot { width: 10px; height: 10px; border-radius: 50%; }
        .product-name { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .product-count { font-size: 0.78rem; color: var(--text-secondary); }
        .stages-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--sp-6); }
        .stage-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-lg); padding: var(--sp-5); cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; }
        .stage-card:hover:not(.stage-card-empty) { border-color: var(--accent); box-shadow: 0 4px 12px rgba(255,107,53,0.08); }
        .stage-card-empty { border-style: dashed; opacity: 0.7; }
        .stage-empty-message { padding: var(--sp-6) 0; text-align: center; font-size: 0.82rem; color: var(--text-muted); }
        .stage-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-4); }
        .stage-name { font-size: 0.82rem; font-weight: 600; color: var(--text-primary); }
        .stage-badge { font-size: 0.62rem; font-weight: 700; padding: 2px 8px; border-radius: 999px; letter-spacing: 0.04em; }
        .stage-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.78rem; padding: var(--sp-1) 0; }
        .stage-row-name { color: var(--text-secondary); }
        .stage-row-bar { width: 48px; height: 4px; background: var(--border-light); border-radius: 2px; overflow: hidden; margin: 0 var(--sp-2); }
        .stage-row-bar-fill { height: 100%; border-radius: 2px; }
        .stage-row-count { font-weight: 600; font-size: 0.72rem; color: var(--text-primary); min-width: 56px; text-align: right; white-space: nowrap; }
        .stage-total { border-top: 1px solid var(--border-light); margin-top: var(--sp-3); padding-top: var(--sp-3); display: flex; justify-content: space-between; font-size: 0.82rem; font-weight: 600; }
        .release-banner { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-lg); border-left: 4px solid var(--purple); padding: var(--sp-6); }
        .release-banner-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--sp-6); }
        .release-banner-left { flex: 1; }
        .release-banner-title-row { display: flex; align-items: center; gap: var(--sp-3); margin-bottom: var(--sp-2); }
        .release-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--purple); }
        .release-title { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .release-temp-badge { font-size: 0.65rem; font-weight: 600; color: var(--purple); background: rgba(139,92,246,0.1); padding: 2px 10px; border-radius: 999px; }
        .release-stats-row { padding-left: 22px; }
        .release-total { font-size: 0.87rem; color: var(--text-secondary); }
        .release-progress-wrap { display: flex; align-items: center; gap: var(--sp-3); min-width: 200px; }
        .release-progress-bar { flex: 1; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden; }
        .release-progress-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--purple), #A78BFA); }
        .release-progress-label { font-size: 0.72rem; font-weight: 600; color: var(--purple); white-space: nowrap; }
        .release-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: var(--sp-3); }
        .release-mini-card { background: var(--bg-card-alt); border: 1px solid var(--border-light); border-radius: var(--r-md); padding: var(--sp-4) var(--sp-3); text-align: center; transition: border-color 0.15s, transform 0.15s; cursor: pointer; }
        .release-mini-card:hover { border-color: var(--accent); transform: translateY(-1px); }
        .release-mini-value { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); line-height: 1; margin-bottom: 2px; }
        .release-mini-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 500; }
        .chart-container { width: 100%; height: 220px; position: relative; }
        .lang-row { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; }
        .lang-name { font-size: 0.82rem; color: var(--text-secondary); width: 80px; flex-shrink: 0; }
        .lang-bar { flex: 1; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden; }
        .lang-bar-fill { height: 100%; border-radius: 3px; background: var(--blue); }
        .lang-count { font-size: 0.82rem; font-weight: 600; color: var(--text-primary); width: 36px; text-align: right; }
        .activity-item { display: flex; gap: var(--sp-3); padding: var(--sp-3) 0; border-bottom: 1px solid var(--border-light); }
        .activity-item:last-child { border-bottom: none; }
        .activity-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
        .activity-name { font-size: 0.82rem; font-weight: 500; }
        .activity-path { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
        .activity-time { font-size: 0.68rem; color: var(--text-muted); margin-top: 2px; }
        .overview-pills { display: flex; gap: var(--sp-2); margin-bottom: var(--sp-8); }
        .pill-btn { padding: var(--sp-2) var(--sp-5); border: 1px solid var(--border); border-radius: 999px; background: var(--bg-card-alt); color: var(--text-secondary); font-family: inherit; font-size: 0.82rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease; }
        .pill-btn:hover { border-color: var(--text-muted); color: var(--text-primary); }
        .pill-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .subview { display: none; }
        .subview.active { display: block; }
        .tree-container { background: var(--bg-tree); border-radius: var(--r-lg); height: calc(100vh - 60px - 64px); display: flex; flex-direction: column; overflow: hidden; }
        .tree-toolbar { padding: var(--sp-4) var(--sp-5); display: flex; align-items: center; gap: var(--sp-4); border-bottom: 1px solid rgba(255,255,255,0.06); }
        .tree-pill { padding: var(--sp-2) var(--sp-4); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sidebar); border-radius: 999px; font-family: inherit; font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .tree-pill:hover { background: rgba(255,255,255,0.1); color: white; }
        .tree-pill.active { background: var(--accent); border-color: var(--accent); color: white; }
        .tree-btn { padding: var(--sp-2) var(--sp-3); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); border-radius: var(--r-md); font-family: inherit; font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: var(--sp-2); }
        .tree-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tree-btn svg { width: 14px; height: 14px; }
        .tree-legend { padding: var(--sp-3) var(--sp-5); display: flex; gap: var(--sp-5); font-size: 0.72rem; color: var(--text-sidebar); border-top: 1px solid rgba(255,255,255,0.06); }
        .tree-legend-item { display: flex; align-items: center; gap: var(--sp-2); }
        .tree-legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .tree-canvas { flex: 1; overflow: hidden; position: relative; }
        .tree-canvas svg { width: 100%; height: 100%; }
        .tree-canvas .node rect { transition: fill 0.3s ease, stroke 0.3s ease; }
        .tree-canvas .node rect:hover { filter: brightness(1.15); stroke-width: 3 !important; }
        .tree-canvas .node text { user-select: none; pointer-events: none; font-family: 'DM Sans', sans-serif; }
        .matrix-filters { display: flex; gap: var(--sp-4); margin-bottom: var(--sp-6); align-items: center; flex-wrap: wrap; }
        .filter-select { padding: var(--sp-2) var(--sp-3); border: 1px solid var(--border); border-radius: var(--r-md); font-family: inherit; font-size: 0.82rem; background: var(--bg-card); color: var(--text-primary); }
        .matrix-table { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-lg); overflow: hidden; border-collapse: separate; border-spacing: 0; }
        .matrix-table th { background: var(--bg-card-alt); padding: var(--sp-3) var(--sp-4); font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.04em; border-bottom: 1px solid var(--border); text-align: center; }
        .matrix-table th:first-child { text-align: left; }
        .matrix-table td { padding: var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--border-light); font-size: 0.82rem; text-align: center; }
        .matrix-table td:first-child { text-align: left; font-weight: 500; }
        .matrix-table tr:last-child td { border-bottom: none; }
        .matrix-table .category-row td { background: var(--bg-card-alt); font-weight: 600; font-size: 0.78rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.03em; }
        .cell-yes { background: rgba(16,185,129,0.08); color: var(--green); font-weight: 600; cursor: pointer; transition: background 0.15s; }
        .cell-yes:hover { background: rgba(16,185,129,0.18); }
        .cell-no { background: rgba(239,68,68,0.05); color: var(--red); opacity: 0.6; }
        .matrix-section-header { cursor: pointer; user-select: none; }
        .matrix-section-header:hover { background: rgba(255,107,53,0.05); }
        .matrix-section-arrow { display: inline-block; transition: transform 0.2s; margin-right: 8px; }
        .matrix-section-header.collapsed .matrix-section-arrow { transform: rotate(-90deg); }
        .files-filters-bar { display: flex; align-items: center; gap: var(--sp-3); margin-bottom: var(--sp-4); flex-wrap: wrap; }
        .files-search { flex: 1; min-width: 200px; max-width: 320px; position: relative; }
        .files-search input { width: 100%; padding: var(--sp-2) var(--sp-4) var(--sp-2) 36px; border: 1px solid var(--border); border-radius: var(--r-md); font-family: inherit; font-size: 0.82rem; background: var(--bg-card); }
        .files-search input:focus { outline: none; border-color: var(--accent); }
        .files-search svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: var(--text-muted); }
        .files-active-count { font-size: 0.75rem; color: var(--text-muted); }
        .files-active-count strong { color: var(--accent); font-weight: 600; }
        .ms-dropdown { position: relative; display: inline-block; }
        .ms-trigger { display: flex; align-items: center; gap: 6px; padding: 7px 12px; border: 1px solid var(--border); border-radius: var(--r-md); background: var(--bg-card); font-family: inherit; font-size: 0.78rem; color: var(--text-secondary); cursor: pointer; transition: border-color 0.15s; white-space: nowrap; user-select: none; }
        .ms-trigger:hover { border-color: var(--text-muted); }
        .ms-trigger.has-selection { border-color: var(--accent); color: var(--text-primary); }
        .ms-trigger svg { width: 12px; height: 12px; flex-shrink: 0; transition: transform 0.2s; }
        .ms-dropdown.open .ms-trigger svg { transform: rotate(180deg); }
        .ms-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; background: var(--accent); color: white; font-size: 0.65rem; font-weight: 700; }
        .ms-panel { display: none; position: absolute; top: calc(100% + 4px); left: 0; min-width: 220px; max-height: 320px; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-md); box-shadow: 0 8px 24px rgba(0,0,0,0.08); z-index: 100; padding: 6px 0; }
        .ms-dropdown.open .ms-panel { display: block; }
        .ms-panel-group { padding: 4px 12px 2px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
        .ms-option { display: flex; align-items: center; gap: 8px; padding: 6px 12px; font-size: 0.78rem; color: var(--text-secondary); cursor: pointer; transition: background 0.1s; }
        .ms-option:hover { background: var(--bg-card-alt); }
        .ms-check { width: 16px; height: 16px; border: 1.5px solid var(--border); border-radius: 3px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
        .ms-option.selected .ms-check { background: var(--accent); border-color: var(--accent); }
        .ms-option.selected .ms-check::after { content: ''; width: 8px; height: 5px; border-left: 2px solid white; border-bottom: 2px solid white; transform: rotate(-45deg); margin-top: -2px; }
        .files-clear-btn { padding: 7px 12px; border: 1px solid var(--border); border-radius: var(--r-md); background: none; font-family: inherit; font-size: 0.75rem; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
        .files-clear-btn:hover { border-color: var(--red); color: var(--red); }
        .active-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: var(--sp-3); }
        .active-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 999px; background: rgba(255,107,53,0.1); color: var(--accent); font-size: 0.68rem; font-weight: 500; }
        .active-tag button { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.8rem; line-height: 1; padding: 0; margin-left: 2px; opacity: 0.6; }
        .active-tag button:hover { opacity: 1; }
        .files-table { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-lg); overflow: hidden; border-collapse: separate; border-spacing: 0; }
        .files-table th { background: var(--bg-card-alt); padding: var(--sp-3) var(--sp-4); font-size: 0.72rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.04em; border-bottom: 1px solid var(--border); text-align: left; cursor: pointer; user-select: none; transition: color 0.15s; }
        .files-table th:hover { color: var(--accent); }
        .files-table th .sort-arrow { display: inline-block; margin-left: 4px; opacity: 0.3; font-size: 0.65rem; }
        .files-table td { padding: var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--border-light); font-size: 0.82rem; }
        .files-table tr:hover td { background: rgba(255,107,53,0.02); }
        .files-table tr:last-child td { border-bottom: none; }
        .file-name-cell { font-weight: 500; color: var(--text-primary); }
        .tag { display: inline-block; padding: 1px 8px; border-radius: var(--r-sm); font-size: 0.68rem; font-weight: 500; }
        .tag-blue { background: rgba(59,130,246,0.1); color: var(--blue); }
        .tag-green { background: rgba(16,185,129,0.1); color: var(--green); }
        .tag-amber { background: rgba(245,158,11,0.1); color: var(--amber); }
        .tag-gray { background: var(--bg-card-alt); color: var(--text-secondary); }
        .files-pagination { display: flex; align-items: center; justify-content: space-between; margin-top: var(--sp-4); font-size: 0.78rem; color: var(--text-secondary); }
        .page-btn { padding: var(--sp-2) var(--sp-3); border: 1px solid var(--border); border-radius: var(--r-md); background: var(--bg-card); font-family: inherit; font-size: 0.78rem; cursor: pointer; color: var(--text-secondary); }
        .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .page-btn:disabled { opacity: 0.4; cursor: default; }
        .gaps-filters { display: flex; gap: var(--sp-4); margin-bottom: var(--sp-6); align-items: center; flex-wrap: wrap; }
        .gaps-group { margin-bottom: var(--sp-6); }
        .gaps-group-header { display: flex; align-items: center; gap: var(--sp-3); margin-bottom: var(--sp-4); }
        .gaps-group-dot { width: 10px; height: 10px; border-radius: 50%; }
        .gaps-group-title { font-size: 0.87rem; font-weight: 600; }
        .gaps-group-count { font-size: 0.72rem; font-weight: 600; padding: 2px 10px; border-radius: 999px; }
        .gaps-list { display: flex; flex-direction: column; gap: var(--sp-2); }
        .gap-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-md); padding: var(--sp-3) var(--sp-4); display: flex; align-items: center; justify-content: space-between; font-size: 0.82rem; transition: border-color 0.15s; cursor: pointer; }
        .gap-item:hover { border-color: var(--text-muted); }
        .gap-item.expanded { border-radius: var(--r-md) var(--r-md) 0 0; }
        .gap-explanation { background: var(--bg-card-alt); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--r-md) var(--r-md); padding: var(--sp-3) var(--sp-4); font-size: 0.78rem; color: var(--text-secondary); margin-top: calc(-1 * var(--sp-2)); margin-bottom: var(--sp-2); line-height: 1.5; display: none; }
        .gap-explanation.open { display: block; }
        .gap-explanation strong { color: var(--text-primary); }
        .gap-feature { font-weight: 500; }
        .gap-type { color: var(--text-secondary); font-size: 0.78rem; }
        .gap-path { color: var(--text-muted); font-size: 0.72rem; }
        .gap-score { font-weight: 700; font-size: 0.78rem; min-width: 60px; text-align: right; }
        .page-title { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin-bottom: var(--sp-2); }
        .page-desc { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: var(--sp-6); }
        .folder-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 100; display: flex; align-items: center; justify-content: center; padding: var(--sp-6); opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
        .folder-overlay.open { opacity: 1; pointer-events: auto; }
        .folder-modal { background: var(--bg-card); border-radius: var(--r-xl); box-shadow: 0 24px 64px rgba(0,0,0,0.18); width: 100%; max-width: 720px; max-height: 85vh; display: flex; flex-direction: column; transform: translateY(12px) scale(0.97); transition: transform 0.2s ease; }
        .folder-overlay.open .folder-modal { transform: translateY(0) scale(1); }
        .folder-modal-header { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-5) var(--sp-6); border-bottom: 1px solid var(--border); }
        .folder-modal-header-left { display: flex; align-items: center; gap: var(--sp-3); }
        .folder-back-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: var(--r-md); background: var(--bg-card); color: var(--text-secondary); cursor: pointer; }
        .folder-back-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .folder-back-btn:disabled { opacity: 0.3; cursor: default; }
        .folder-modal-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .folder-modal-path { font-size: 0.7rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: 1px; }
        .folder-close-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: none; border-radius: var(--r-md); background: transparent; color: var(--text-secondary); cursor: pointer; }
        .folder-close-btn:hover { background: var(--bg-card-alt); color: var(--text-primary); }
        .folder-modal-body { flex: 1; overflow-y: auto; padding: var(--sp-5) var(--sp-6); }
        .folder-section-label { font-size: 0.72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--sp-3); }
        .folder-section-label:not(:first-child) { margin-top: var(--sp-6); }
        .folder-item { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-3) var(--sp-4); border: 1px solid var(--border-light); border-radius: var(--r-md); margin-bottom: var(--sp-2); cursor: pointer; transition: all 0.12s ease; background: var(--bg-card); }
        .folder-item:hover { border-color: var(--accent); background: rgba(255,107,53,0.02); }
        .folder-item-left { display: flex; align-items: center; gap: var(--sp-3); }
        .folder-item-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .folder-item-name { font-size: 0.87rem; font-weight: 500; color: var(--text-primary); }
        .folder-item-right { display: flex; align-items: center; gap: var(--sp-3); }
        .folder-item-count { font-size: 0.75rem; color: var(--text-secondary); }
        .folder-item-arrow { width: 16px; height: 16px; color: var(--text-muted); }
        .folder-item.empty { border-color: rgba(239,68,68,0.15); background: rgba(239,68,68,0.02); }
        .folder-item.empty .folder-item-name { color: var(--red); }
        .folder-item.empty .folder-item-count { color: var(--red); }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-2) var(--sp-4); border-radius: var(--r-sm); transition: background 0.1s ease; }
        .file-item:hover { background: var(--bg-card-alt); }
        .file-item-left { display: flex; align-items: center; gap: var(--sp-2); }
        .file-item-icon { width: 16px; height: 16px; color: var(--text-muted); flex-shrink: 0; }
        .file-item-name { font-size: 0.82rem; color: var(--text-primary); }
        .file-item-date { font-size: 0.7rem; color: var(--text-muted); }
        .folder-modal-footer { padding: var(--sp-4) var(--sp-6); border-top: 1px solid var(--border); background: var(--bg-card-alt); border-radius: 0 0 var(--r-xl) var(--r-xl); display: flex; align-items: center; justify-content: space-between; font-size: 0.78rem; color: var(--text-secondary); }
        .folder-modal-footer strong { font-weight: 600; color: var(--text-primary); }
        .folder-empty-state { text-align: center; padding: var(--sp-12) var(--sp-6); color: var(--text-muted); font-size: 0.87rem; }
        .empty-state { text-align: center; padding: var(--sp-12) var(--sp-8); color: var(--text-muted); }
        .empty-state-title { font-size: 1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--sp-2); }
        .empty-state-desc { font-size: 0.82rem; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg></div>
            <h1>Content Tree</h1>
            <p>Worksection Marketing</p>
        </div>
        <nav class="sidebar-nav">
            <div class="sidebar-label">Navigation</div>
            <button class="nav-item active" onclick="switchTab('overview')"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Overview</button>
            <button class="nav-item" onclick="switchTab('tree')"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>Tree</button>
            <button class="nav-item" onclick="switchTab('matrix')"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>Matrix<span class="nav-badge">NEW</span></button>
            <button class="nav-item" onclick="switchTab('files')"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Files<span class="nav-badge" id="navFilesBadge">0</span></button>
            <button class="nav-item" onclick="switchTab('gaps')"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Gaps<span class="nav-badge" id="navGapsBadge">0</span></button>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-stat"><span class="sidebar-stat-value" id="sidebarTotal">0</span><span class="sidebar-stat-label">files</span></div>
            <div class="sidebar-stat-bar"><div class="sidebar-stat-bar-fill" id="sidebarBarFill" style="width:0%"></div></div>
            <div id="sidebarCoverage" style="font-size:0.65rem;color:var(--text-sidebar);margin-top:4px;">loading...</div>
        </div>
    </aside>
    <div class="main">
        <header class="header">
            <div class="search-box"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="globalSearch" placeholder="Search files, topics..."><span class="search-kbd">Ctrl+K</span></div>
            <div class="header-meta"><span>Updated: <strong id="headerTimestamp">...</strong></span><button class="btn-refresh" onclick="location.reload()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Refresh</button></div>
        </header>
        <div class="content">
            <section id="tab-overview" class="tab-panel active"><div id="overview-metrics" class="metrics-grid"></div><div class="overview-pills"><button class="pill-btn active" onclick="switchSubview('all',this)">Overview</button><button class="pill-btn" onclick="switchSubview('ws1',this)">WS 1.0</button><button class="pill-btn" onclick="switchSubview('ws2',this)">WS 2.0</button><button class="pill-btn" onclick="switchSubview('release',this)">WS 2.0 Release</button></div><div id="overviewContent"></div></section>
            <section id="tab-tree" class="tab-panel"><div class="tree-container"><div class="tree-toolbar"><button class="tree-pill active" onclick="switchTreeProduct('ws1',this)">WS 1.0</button><button class="tree-pill" onclick="switchTreeProduct('ws2',this)">WS 2.0</button><button class="tree-pill" onclick="switchTreeProduct('release',this)">WS 2.0 Release</button><div style="flex:1"></div><button class="tree-btn" onclick="treeZoomOut()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/></svg></button><span id="tree-zoom-label" style="color:var(--text-sidebar);font-size:0.78rem;min-width:48px;text-align:center;">100%</span><button class="tree-btn" onclick="treeZoomIn()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/></svg></button><button class="tree-btn" onclick="treeResetZoom()">Reset</button><button class="tree-btn" onclick="treeExpandAll()">Expand</button><button class="tree-btn" onclick="treeCollapseAll()">Collapse</button></div><div class="tree-canvas" id="tree-canvas"><svg id="treeSvg"></svg></div><div class="tree-legend"><div class="tree-legend-item"><div class="tree-legend-dot" style="background:var(--green);"></div> Has content</div><div class="tree-legend-item"><div class="tree-legend-dot" style="background:var(--red);"></div> Empty</div><div class="tree-legend-item"><div class="tree-legend-dot" style="background:#6366F1;"></div> File</div></div></div></section>
            <section id="tab-matrix" class="tab-panel"><div class="page-title">Coverage Matrix</div><div class="page-desc">Topic x content type â€” green = has files, red = gap</div><div class="matrix-filters"><div class="overview-pills" style="margin-bottom:0;"><button class="pill-btn active" onclick="matrixSetProduct('all',this)">All</button><button class="pill-btn" onclick="matrixSetProduct('ws1',this)">WS 1.0</button><button class="pill-btn" onclick="matrixSetProduct('ws2',this)">WS 2.0</button><button class="pill-btn" onclick="matrixSetProduct('release',this)">WS 2.0 Release</button></div><div style="flex:1;"></div><select class="filter-select" id="matrixLangSelect" onchange="matrixRender()"><option value="">All languages</option></select><select class="filter-select" id="matrixStageSelect" onchange="matrixRender()"><option value="">All stages</option><option>Pre-Registration</option><option>Trial</option><option>Success_Client</option></select></div><table class="matrix-table"><thead><tr id="matrixHead"></tr></thead><tbody id="matrixTableBody"></tbody></table></section>
            <section id="tab-files" class="tab-panel"><div style="display:flex;align-items:baseline;gap:var(--sp-3);margin-bottom:var(--sp-2);"><div class="page-title" style="margin-bottom:0;">Files</div><span class="files-active-count" id="filesCount"></span></div><div class="page-desc">Filter by category, topic, type, and language</div><div class="files-filters-bar"><div class="overview-pills" style="margin-bottom:0;"><button class="pill-btn active" onclick="filesSetProduct('all',this)">All</button><button class="pill-btn" onclick="filesSetProduct('WS 1.0',this)">WS 1.0</button><button class="pill-btn" onclick="filesSetProduct('WS 2.0 Release',this)">WS 2.0 Release</button></div><div class="ms-dropdown" id="msCategoryDropdown"></div><div class="ms-dropdown" id="msTopicDropdown"></div><div class="ms-dropdown" id="msFormatDropdown"></div><div class="ms-dropdown" id="msLangDropdown"></div><div class="ms-dropdown" id="msStatusDropdown"></div><div style="flex:1;"></div><div class="files-search"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="filesSearchInput" placeholder="Search by name..." oninput="filesApplyFilters()"></div><button class="files-clear-btn" onclick="filesClearAll()">Reset</button></div><div class="active-tags" id="filesActiveTags"></div><table class="files-table"><thead><tr><th onclick="filesSort('name')">Name <span class="sort-arrow" id="sort-name"></span></th><th onclick="filesSort('category')">Category <span class="sort-arrow" id="sort-category"></span></th><th onclick="filesSort('topic')">Topic <span class="sort-arrow" id="sort-topic"></span></th><th onclick="filesSort('content_type')">Type <span class="sort-arrow" id="sort-content_type"></span></th><th onclick="filesSort('language')">Lang <span class="sort-arrow" id="sort-language"></span></th><th onclick="filesSort('status')">Status <span class="sort-arrow" id="sort-status"></span></th><th onclick="filesSort('size')">Size <span class="sort-arrow" id="sort-size"></span></th></tr></thead><tbody id="filesTableBody"></tbody></table><div class="files-pagination"><span id="filesPagInfo"></span><div style="display:flex;gap:8px;"><button class="page-btn" id="filesPrev" onclick="filesPageChange(-1)">Prev</button><button class="page-btn" id="filesNext" onclick="filesPageChange(1)">Next</button></div></div></section>
            <section id="tab-gaps" class="tab-panel"><div class="page-title">Gap Analysis</div><div class="page-desc" id="gapsDesc">Loading...</div><div class="gaps-filters"><div class="overview-pills" style="margin-bottom:0;"><button class="pill-btn active" onclick="gapsSetProduct('all',this)">All</button><button class="pill-btn" onclick="gapsSetProduct('ws1',this)">WS 1.0</button><button class="pill-btn" onclick="gapsSetProduct('ws2',this)">WS 2.0</button></div><div style="flex:1;"></div><select class="filter-select" id="gapsSeveritySelect" onchange="gapsRender()"><option value="">All priorities</option><option value="1">Critical</option><option value="2">High</option><option value="3">Medium</option><option value="4">Low</option></select><select class="filter-select" id="gapsLangSelect" onchange="gapsRender()"><option value="">All languages</option></select><select class="filter-select" id="gapsCategorySelect" onchange="gapsRender()"><option value="">All categories</option></select></div><div id="gapsListContainer"></div></section>
        </div>
    </div>
    <div class="folder-overlay" id="folderOverlay" onclick="if(event.target===this)closeFolderModal()"><div class="folder-modal"><div class="folder-modal-header"><div class="folder-modal-header-left"><button class="folder-back-btn" id="folderBackBtn" onclick="navigateBack()" disabled><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button><div><div class="folder-modal-title" id="folderModalTitle">Folder</div><div class="folder-modal-path" id="folderModalPath"></div></div></div><button class="folder-close-btn" onclick="closeFolderModal()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="folder-modal-body" id="folderModalBody"></div><div class="folder-modal-footer"><div><strong id="folderFileCount">0</strong> files</div><div id="folderEmptyCount" style="color:var(--text-muted);"></div></div></div></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    var DATA = null;
    var STAGES = ['Pre-Registration','Trial','Success_Client'];
    var CATEGORIES = ['Features','Business_Types','Competitors','Pains','PM_Education'];
    var STAGE_LABELS = {'Pre-Registration':'TOFU','Trial':'MOFU','Success_Client':'BOFU'};
    var STAGE_COLORS = {'Pre-Registration':'#3B82F6','Trial':'#F59E0B','Success_Client':'#10B981'};
    var MATRIX_TYPES = ['article','landing','video','static_ad','video_ad','smm'];

    function loadData() {
        fetch('data.json').then(function(r){return r.json();}).then(function(d){
            DATA = d;
            initDashboard();
        }).catch(function(e){
            document.querySelector('.content').innerHTML = '<div class="empty-state"><div class="empty-state-title">Failed to load data.json</div><div class="empty-state-desc">Run: python3 scripts/db/sync.py && python3 scripts/db/export.py</div></div>';
        });
    }
    window.addEventListener('DOMContentLoaded', loadData);

    function initDashboard() {
        var dt = new Date(DATA.generated_at);
        document.getElementById('headerTimestamp').textContent = dt.toLocaleDateString('uk-UA',{day:'numeric',month:'short',year:'numeric'}) + ', ' + dt.toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit'});
        document.getElementById('sidebarTotal').textContent = DATA.total_files;
        document.getElementById('navFilesBadge').textContent = DATA.total_files;
        document.getElementById('navGapsBadge').textContent = DATA.gaps.length;
        var primaryLangs = DATA.languages.filter(function(l){return l.is_primary;}).length;
        var totalSlots = DATA.topics.length * MATRIX_TYPES.length * primaryLangs;
        var filled = totalSlots - DATA.gaps.length;
        var coveragePct = totalSlots > 0 ? ((filled / totalSlots) * 100).toFixed(1) : 0;
        document.getElementById('sidebarBarFill').style.width = coveragePct + '%';
        document.getElementById('sidebarCoverage').textContent = coveragePct + '% coverage (' + filled + ' / ' + totalSlots + ')';
        renderOverviewMetrics('all');
        renderOverviewContent('all');
        initMatrixFilters();
        matrixRender();
        filesInitFilters();
        filesApplyFilters();
        initGapsFilters();
        gapsRender();
        var hash = window.location.hash.replace('#','');
        if (hash && document.getElementById('tab-' + hash)) switchTab(hash);
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.getElementById('globalSearch').focus(); }
            if (e.key === 'Escape') closeFolderModal();
        });
        document.getElementById('globalSearch').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { var q = e.target.value.trim(); if (q) { switchTab('files'); document.getElementById('filesSearchInput').value = q; filesApplyFilters(); } }
        });
    }

    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(function(i){i.classList.remove('active');});
        var nav = document.querySelector('.nav-item[onclick*="\''+tabName+'\'"]');
        if (nav) nav.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});
        document.getElementById('tab-' + tabName).classList.add('active');
        if (tabName === 'tree') initTree();
        window.location.hash = tabName;
    }

    /* OVERVIEW */
    function renderOverviewMetrics(view) {
        var s = DATA.stats;
        var total, published, drafts, label, sub;
        if (view === 'all') {
            total = DATA.total_files; published = s.by_status.published || 0; drafts = s.by_status.draft || 0;
            label = 'Total files';
            sub = 'WS 1.0: '+(s.by_product['WS 1.0']||0)+' | Release: '+(s.by_product['WS 2.0 Release']||0);
        } else if (view === 'ws1') {
            var files = DATA.files.filter(function(f){return f.product==='WS 1.0';});
            total = files.length; published = files.filter(function(f){return f.status==='published';}).length; drafts = total - published;
            label = 'WS 1.0 files';
            sub = 'Pre-Reg: '+files.filter(function(f){return f.stage==='Pre-Registration';}).length+' | Trial: '+files.filter(function(f){return f.stage==='Trial';}).length+' | Success: '+files.filter(function(f){return f.stage==='Success_Client';}).length;
        } else if (view === 'ws2') {
            total = 0; published = 0; drafts = 0; label = 'WS 2.0 files'; sub = 'Structure ready, content pending';
        } else {
            var files = DATA.files.filter(function(f){return f.product==='WS 2.0 Release';});
            total = files.length; published = files.filter(function(f){return f.status==='published';}).length; drafts = total - published;
            label = 'WS 2.0 Release files'; sub = 'Temporary project';
        }
        var pubPct = total > 0 ? Math.round(published / total * 100) : 0;
        var gapsCrit = DATA.gaps.filter(function(g){return g.priority===1;}).length;
        document.getElementById('overview-metrics').innerHTML =
            '<div class="metric-card"><div class="metric-header"><div class="metric-icon" style="background:rgba(59,130,246,0.1);"><svg style="color:#3B82F6;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div></div><div class="metric-value">'+total+'</div><div class="metric-label">'+label+'</div><div class="metric-sub" style="color:#10B981;">'+sub+'</div></div>'+
            '<div class="metric-card"><div class="metric-header"><div class="metric-icon" style="background:rgba(16,185,129,0.1);"><svg style="color:#10B981;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><span class="metric-badge" style="background:rgba(16,185,129,0.1);color:#10B981;">'+pubPct+'%</span></div><div class="metric-value">'+published+'</div><div class="metric-label">Published</div><div class="metric-sub" style="color:#10B981;">'+pubPct+'% published</div></div>'+
            '<div class="metric-card"><div class="metric-header"><div class="metric-icon" style="background:rgba(245,158,11,0.1);"><svg style="color:#F59E0B;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div></div><div class="metric-value">'+drafts+'</div><div class="metric-label">Drafts</div><div class="metric-sub" style="color:#F59E0B;">Pending publication</div></div>'+
            '<div class="metric-card"><div class="metric-header"><div class="metric-icon" style="background:rgba(239,68,68,0.1);"><svg style="color:#EF4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div></div><div class="metric-value">'+DATA.gaps.length+'</div><div class="metric-label">Content gaps</div><div class="metric-sub" style="color:#EF4444;">Critical: '+gapsCrit+'</div></div>';
    }

    function switchSubview(view, btn) {
        if (btn) { btn.closest('.overview-pills').querySelectorAll('.pill-btn').forEach(function(p){p.classList.remove('active');}); btn.classList.add('active'); }
        renderOverviewMetrics(view);
        renderOverviewContent(view);
    }

    function renderOverviewContent(view) {
        var el = document.getElementById('overviewContent');
        var html = '';
        if (view === 'all' || view === 'ws1') html += renderProductFunnel('WS 1.0');
        if (view === 'all' || view === 'ws2') html += renderWs2Empty();
        if (view === 'all' || view === 'release') html += renderReleaseBanner();
        if (view === 'ws2') { el.innerHTML = renderWs2Empty(); return; }
        html += '<div class="section-grid"><div class="card"><div class="card-title">Content types</div><div class="chart-container"><canvas id="chartTypes"></canvas></div></div><div class="card"><div class="card-title">Status breakdown</div><div class="chart-container"><canvas id="chartStatus"></canvas></div></div></div>';
        html += renderLangAndActivity(view);
        el.innerHTML = html;
        initCharts(view);
    }

    function renderProductFunnel(product) {
        var files = DATA.files.filter(function(f){return f.product===product;});
        var h = '<div class="product-section"><div class="product-header"><div class="product-label"><span class="product-dot" style="background:#3B82F6;"></span><span class="product-name">'+product+'</span><span class="product-count">'+files.length+' files</span></div></div><div class="stages-grid-3">';
        STAGES.forEach(function(stage) {
            var sf = files.filter(function(f){return f.stage===stage;});
            var empty = sf.length === 0;
            h += '<div class="stage-card'+(empty?' stage-card-empty':'')+'" onclick="openStageFiles(\''+product+'\',\''+stage+'\')"><div class="stage-header"><span class="stage-name">'+stage+'</span><span class="stage-badge" style="background:'+STAGE_COLORS[stage]+'20;color:'+STAGE_COLORS[stage]+';">'+STAGE_LABELS[stage]+'</span></div>';
            CATEGORIES.forEach(function(cat) {
                var catTopics = DATA.topics.filter(function(t){return t.category===cat;});
                if (catTopics.length === 0) return;
                var covered = {};
                sf.forEach(function(f){ if(f.category===cat && f.topic) covered[f.topic]=true; });
                var covCount = Object.keys(covered).length;
                var pct = Math.round(covCount / catTopics.length * 100);
                var color = pct >= 60 ? '#3B82F6' : pct >= 30 ? '#F59E0B' : '#EF4444';
                h += '<div class="stage-row"><span class="stage-row-name">'+cat+'</span><div class="stage-row-bar"><div class="stage-row-bar-fill" style="width:'+pct+'%;background:'+color+';"></div></div><span class="stage-row-count">'+covCount+'/'+catTopics.length+'</span></div>';
            });
            h += '<div class="stage-total"><span>Total</span><span>'+sf.length+' files</span></div>';
            h += '</div>';
        });
        h += '</div></div>';
        return h;
    }

    function renderWs2Empty() {
        return renderProductFunnel('WS 2.0');
    }

    function renderReleaseBanner() {
        var files = DATA.files.filter(function(f){return f.product==='WS 2.0 Release';});
        var published = files.filter(function(f){return f.status==='published';}).length;
        var pct = files.length > 0 ? Math.round(published / files.length * 100) : 0;
        var byCt = {};
        files.forEach(function(f){ byCt[f.content_type] = (byCt[f.content_type]||0)+1; });
        var cards = '';
        Object.keys(byCt).sort().forEach(function(ct){
            var dn = DATA.content_types.find(function(c){return c.name===ct;});
            cards += '<div class="release-mini-card" onclick="openReleaseFolder(\''+ct+'\')"><div class="release-mini-value">'+byCt[ct]+'</div><div class="release-mini-label">'+(dn?dn.display_name:ct)+'</div></div>';
        });
        return '<div class="product-section"><div class="release-banner"><div class="release-banner-header"><div class="release-banner-left"><div class="release-banner-title-row"><span class="release-dot"></span><span class="release-title">WS 2.0 Release</span><span class="release-temp-badge">temporary project</span></div><div class="release-stats-row"><span class="release-total">'+files.length+' files</span></div></div><div class="release-progress-wrap"><div class="release-progress-bar"><div class="release-progress-fill" style="width:'+pct+'%"></div></div><span class="release-progress-label">'+pct+'% published</span></div></div><div class="release-cards-grid">'+cards+'</div></div></div>';
    }

    function renderLangAndActivity(view) {
        var files = view === 'ws1' ? DATA.files.filter(function(f){return f.product==='WS 1.0';}) :
                    view === 'release' ? DATA.files.filter(function(f){return f.product==='WS 2.0 Release';}) : DATA.files;
        var lc = {};
        DATA.languages.forEach(function(l){ lc[l.code] = 0; });
        files.forEach(function(f){ if(f.language) lc[f.language] = (lc[f.language]||0)+1; });
        var sorted = Object.entries(lc).sort(function(a,b){return b[1]-a[1];});
        var maxL = sorted.length > 0 ? sorted[0][1] : 1;
        var langH = sorted.map(function(e){ return '<div class="lang-row"><span class="lang-name">'+e[0].toUpperCase()+'</span><div class="lang-bar"><div class="lang-bar-fill" style="width:'+(maxL>0?Math.round(e[1]/maxL*100):0)+'%"></div></div><span class="lang-count">'+e[1]+'</span></div>'; }).join('');
        var recent = files.slice().sort(function(a,b){return new Date(b.modified)-new Date(a.modified);}).slice(0,5);
        var actH = recent.map(function(f){
            var dc = f.status === 'published' ? '#10B981' : '#F59E0B';
            var pp = f.path.split('/').slice(0,-1).join(' / ');
            return '<div class="activity-item"><div class="activity-dot" style="background:'+dc+';"></div><div><div class="activity-name">'+f.name+'</div><div class="activity-path">'+pp+'</div><div class="activity-time">'+timeAgo(new Date(f.modified))+' | '+f.status+'</div></div></div>';
        }).join('');
        return '<div class="section-grid"><div class="card"><div class="card-title">Languages</div>'+(langH||'<div style="color:var(--text-muted);">No data</div>')+'</div><div class="card"><div class="card-title">Recent activity</div>'+(actH||'<div style="color:var(--text-muted);">No files</div>')+'</div></div>';
    }

    function timeAgo(d) {
        var days = Math.floor((Date.now() - d.getTime()) / 86400000);
        if (days === 0) return 'Today';
        if (days === 1) return '1 day ago';
        if (days < 7) return days + ' days ago';
        if (days < 30) return Math.floor(days/7) + ' weeks ago';
        return Math.floor(days/30) + ' months ago';
    }

    var chartT = null, chartS = null;
    function initCharts(view) {
        if (chartT) { chartT.destroy(); chartT = null; }
        if (chartS) { chartS.destroy(); chartS = null; }
        var cT = document.getElementById('chartTypes');
        var cS = document.getElementById('chartStatus');
        if (!cT || !cS) return;
        var files = view === 'ws1' ? DATA.files.filter(function(f){return f.product==='WS 1.0';}) :
                    view === 'release' ? DATA.files.filter(function(f){return f.product==='WS 2.0 Release';}) : DATA.files;
        var byCt = {};
        files.forEach(function(f){ byCt[f.content_type] = (byCt[f.content_type]||0)+1; });
        var cls = Object.keys(byCt), cvs = Object.values(byCt);
        var colors = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6B7280'];
        chartT = new Chart(cT, { type:'doughnut', data:{ labels: cls.map(function(c){ var x = DATA.content_types.find(function(t){return t.name===c;}); return x?x.display_name:c; }), datasets:[{data:cvs,backgroundColor:colors.slice(0,cls.length),borderWidth:0}] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right',labels:{font:{size:11,family:'DM Sans'},color:'#6B7280',padding:8,usePointStyle:true,pointStyleWidth:8}}} }});
        var byS = {};
        files.forEach(function(f){ byS[f.status] = (byS[f.status]||0)+1; });
        var sls = Object.keys(byS), svs = Object.values(byS);
        var scs = sls.map(function(s){return s==='published'?'#10B981':s==='draft'?'#F59E0B':'#9CA3AF';});
        chartS = new Chart(cS, { type:'bar', data:{ labels:sls.map(function(s){return s.charAt(0).toUpperCase()+s.slice(1);}), datasets:[{data:svs,backgroundColor:scs,borderRadius:6,barThickness:40}] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,grid:{color:'#F3F4F6'}},x:{grid:{display:false}}} }});
    }

    /* TREE (D3.js) */
    var treeRoot = null, nodeIdCounter = 0, treeSvgG = null, treeZoomBehavior = null, treeInitialized = false;
    function buildTreeData(product) {
        if (product === 'ws1' || product === 'ws2') {
            var pn = product === 'ws1' ? 'WS 1.0' : 'WS 2.0';
            var files = DATA.files.filter(function(f){return f.product===pn;});
            var root = {name:pn, file_count:files.length, children:[]};
            STAGES.forEach(function(stage){
                var sf = files.filter(function(f){return f.stage===stage;});
                var sn = {name:stage, file_count:sf.length, children:[]};
                CATEGORIES.forEach(function(cat){
                    var cf = sf.filter(function(f){return f.category===cat;});
                    var cn = {name:cat, file_count:cf.length, children:[]};
                    DATA.topics.filter(function(t){return t.category===cat;}).forEach(function(topic){
                        var tf = cf.filter(function(f){return f.topic===topic.name;});
                        cn.children.push({name:topic.display_name, file_count:tf.length, children: tf.slice(0,4).map(function(f){return {name:f.name,file_count:0,is_file:true};})});
                    });
                    sn.children.push(cn);
                });
                root.children.push(sn);
            });
            return root;
        } else {
            var files = DATA.files.filter(function(f){return f.product==='WS 2.0 Release';});
            var root = {name:'WS 2.0 Release', file_count:files.length, children:[]};
            var byCt = {};
            files.forEach(function(f){ if(!byCt[f.content_type]) byCt[f.content_type]=[]; byCt[f.content_type].push(f); });
            Object.keys(byCt).forEach(function(ct){
                var dn = DATA.content_types.find(function(c){return c.name===ct;});
                root.children.push({name:dn?dn.display_name:ct, file_count:byCt[ct].length, children: byCt[ct].slice(0,4).map(function(f){return {name:f.name,file_count:0,is_file:true};})});
            });
            return root;
        }
    }
    function getNodeColor(d) { if(d.data.is_file) return '#6366F1'; return (d.data.file_count||0)>0?'#10B981':'#EF4444'; }
    function truncText(t,m) { return !t?'':t.length>m?t.slice(0,m-1)+'...':t; }
    function diagonal(s,t) { return 'M '+s.y+' '+s.x+' C '+(s.y+t.y)/2+' '+s.x+', '+(s.y+t.y)/2+' '+t.x+', '+t.y+' '+t.x; }

    function initTree() {
        if (treeInitialized) return;
        treeInitialized = true;
        var container = document.getElementById('tree-canvas');
        var w = container.clientWidth||1200, h = container.clientHeight||700;
        var svg = d3.select('#treeSvg').attr('width',w).attr('height',h);
        treeZoomBehavior = d3.zoom().scaleExtent([0.2,3]).clickDistance(10)
            .filter(function(event){ if(event.type==='wheel') return true; if(event.target.closest && event.target.closest('.node')) return false; return !event.ctrlKey && !event.button; })
            .on('zoom', function(event){ treeSvgG.attr('transform', event.transform); document.getElementById('tree-zoom-label').textContent = Math.round(event.transform.k*100)+'%'; });
        svg.call(treeZoomBehavior);
        treeSvgG = svg.append('g');
        svg.call(treeZoomBehavior.transform, d3.zoomIdentity.translate(60, h/2));
        loadTreeProduct('ws1');
    }
    function loadTreeProduct(p) { nodeIdCounter=0; renderTree(buildTreeData(p)); var h=(document.getElementById('tree-canvas').clientHeight||700); d3.select('#treeSvg').transition().duration(400).call(treeZoomBehavior.transform,d3.zoomIdentity.translate(60,h/2)); }
    function switchTreeProduct(p,btn) { document.querySelectorAll('.tree-pill').forEach(function(b){b.classList.remove('active');}); btn.classList.add('active'); loadTreeProduct(p); }
    function renderTree(data) {
        treeSvgG.selectAll('*').remove();
        var root = d3.hierarchy(data);
        d3.tree().nodeSize([55,300]).separation(function(a,b){return a.parent===b.parent?1.0:1.3;})(root);
        root.descendants().forEach(function(d){ d.id=++nodeIdCounter; if(d.depth>0&&d.children){d._children=d.children;d.children=null;} d.x0=d.x; d.y0=d.y; });
        treeRoot = root;
        updateTree(root);
    }
    function updateTree(source) {
        var dur=300;
        d3.tree().nodeSize([55,300]).separation(function(a,b){ if(a.data&&a.data.is_file&&b.data&&b.data.is_file&&a.parent===b.parent) return 0.7; return a.parent===b.parent?1.0:1.3; })(treeRoot);
        var nodes=treeRoot.descendants(), links=treeRoot.links();
        nodes.forEach(function(d){d.y=d.depth*300;});
        var node=treeSvgG.selectAll('g.node').data(nodes,function(d){return d.id;});
        var ne=node.enter().append('g').attr('class','node').attr('transform',function(d){return 'translate('+(source.y0||0)+','+(source.x0||0)+')';}).style('cursor',function(d){return(d.children||d._children)?'pointer':'default';}).on('click',function(ev,d){if(d.children||d._children){if(d.children){d._children=d.children;d.children=null;}else{d.children=d._children;d._children=null;} updateTree(d);}});
        ne.append('rect').attr('width',function(d){return d.data.is_file?200:240;}).attr('height',function(d){return d.data.is_file?32:52;}).attr('x',function(d){return d.data.is_file?-100:-120;}).attr('y',function(d){return d.data.is_file?-16:-26;}).attr('rx',function(d){return d.data.is_file?6:8;}).attr('fill',function(d){return d.data.is_file?'#13151C':'#1A1D27';}).attr('stroke',function(d){return getNodeColor(d);}).attr('stroke-width',function(d){return d.data.is_file?1:2;});
        ne.append('text').attr('dy',function(d){return d.data.is_file?4:-4;}).attr('text-anchor','middle').style('font-size',function(d){return d.data.is_file?'10px':'12px';}).style('font-weight',function(d){return d.data.is_file?'400':'600';}).style('fill',function(d){return d.data.is_file?'#9CA3AF':'#E5E7EB';}).style('font-family',function(d){return d.data.is_file?"'JetBrains Mono',monospace":"'DM Sans',sans-serif";}).text(function(d){return truncText(d.data.name,d.data.is_file?30:28);});
        ne.append('text').attr('dy',14).attr('text-anchor','middle').style('font-size','10px').style('fill','#8B8FA3').text(function(d){return d.data.is_file?'':d.data.file_count+' files';});
        ne.append('circle').attr('cx',function(d){return d.data.is_file?0:105;}).attr('cy',0).attr('r',10).attr('fill','#FF6B35').style('display',function(d){return(!d.data.is_file&&(d.children||d._children))?'block':'none';});
        ne.append('text').attr('class','toggle-label').attr('dx',function(d){return d.data.is_file?0:100;}).attr('dy',5).attr('text-anchor','middle').style('font-size','14px').style('font-weight','bold').style('fill','#fff').style('pointer-events','none').text(function(d){if(d.data.is_file||(!d.children&&!d._children)) return ''; return d.children?'\u2212':'+';});
        var nu=ne.merge(node);
        nu.transition().duration(dur).attr('transform',function(d){return 'translate('+d.y+','+d.x+')';});
        nu.select('rect').attr('stroke',function(d){return getNodeColor(d);});
        nu.select('circle').style('display',function(d){return(!d.data.is_file&&(d.children||d._children))?'block':'none';});
        nu.selectAll('text.toggle-label').text(function(d){if(d.data.is_file||(!d.children&&!d._children)) return ''; return d.children?'\u2212':'+';});
        node.exit().transition().duration(dur).attr('transform','translate('+source.y+','+source.x+')').style('opacity',0).remove();
        var link=treeSvgG.selectAll('path.link').data(links,function(d){return d.target.id;});
        var le=link.enter().insert('path','g').attr('class','link').attr('fill','none').attr('stroke','rgba(255,255,255,0.15)').attr('stroke-width',1.5).attr('d',function(){var o={x:source.x0||0,y:source.y0||0};return diagonal(o,o);});
        le.merge(link).transition().duration(dur).attr('d',function(d){return diagonal(d.source,d.target);});
        link.exit().transition().duration(dur).attr('d',function(){var o={x:source.x,y:source.y};return diagonal(o,o);}).style('opacity',0).remove();
        nodes.forEach(function(d){d.x0=d.x;d.y0=d.y;});
    }
    function treeZoomIn(){d3.select('#treeSvg').transition().duration(300).call(treeZoomBehavior.scaleBy,1.3);}
    function treeZoomOut(){d3.select('#treeSvg').transition().duration(300).call(treeZoomBehavior.scaleBy,0.7);}
    function treeResetZoom(){var h=(document.getElementById('tree-canvas').clientHeight||700);d3.select('#treeSvg').transition().duration(500).call(treeZoomBehavior.transform,d3.zoomIdentity.translate(60,h/2));}
    function treeExpandAll(){if(!treeRoot)return;function ex(d){if(d._children){d.children=d._children;d._children=null;}if(d.children)d.children.forEach(ex);}ex(treeRoot);updateTree(treeRoot);}
    function treeCollapseAll(){if(!treeRoot)return;function co(d){if(d.children){d._children=d.children;d.children=null;}if(d._children)d._children.forEach(co);}if(treeRoot.children)treeRoot.children.forEach(co);updateTree(treeRoot);}

    /* MATRIX */
    var matrixProduct = 'all';
    function initMatrixFilters() {
        var sel = document.getElementById('matrixLangSelect');
        DATA.languages.forEach(function(l){ var o=document.createElement('option'); o.value=l.code; o.textContent=l.name+' ('+l.code+')'; sel.appendChild(o); });
        var head = document.getElementById('matrixHead');
        head.innerHTML = '<th style="min-width:180px;">Topic</th>' + MATRIX_TYPES.map(function(ct){ var dn=DATA.content_types.find(function(c){return c.name===ct;}); return '<th>'+(dn?dn.display_name:ct)+'</th>'; }).join('');
    }
    function matrixSetProduct(p,btn){matrixProduct=p;btn.closest('.overview-pills').querySelectorAll('.pill-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');matrixRender();}
    function matrixRender() {
        var langFilter = document.getElementById('matrixLangSelect').value;
        var stageFilter = document.getElementById('matrixStageSelect') ? document.getElementById('matrixStageSelect').value : '';
        var useFiles = matrixProduct !== 'all' || stageFilter;
        var filteredFiles = useFiles ? DATA.files.filter(function(f) {
            if (matrixProduct === 'ws1' && f.product !== 'WS 1.0') return false;
            if (matrixProduct === 'ws2' && f.product !== 'WS 2.0') return false;
            if (matrixProduct === 'release' && f.product !== 'WS 2.0 Release') return false;
            if (langFilter && f.language !== langFilter) return false;
            if (stageFilter && f.stage !== stageFilter) return false;
            return true;
        }) : null;
        var coverage = DATA.coverage;
        var rows = [];
        CATEGORIES.forEach(function(cat) {
            var topics = DATA.topics.filter(function(t){return t.category===cat;});
            if (topics.length === 0) return;
            rows.push('<tr class="category-row matrix-section-header collapsed" data-matrix-section="'+cat+'" onclick="matrixToggleSection(\''+cat+'\')"><td colspan="'+(MATRIX_TYPES.length+1)+'"><span class="matrix-section-arrow">&#9660;</span>'+cat+' ('+topics.length+')</td></tr>');
            topics.forEach(function(topic) {
                var cells = '<td>'+topic.display_name+'</td>';
                MATRIX_TYPES.forEach(function(ct) {
                    var count = 0;
                    if (useFiles) {
                        filteredFiles.forEach(function(f) {
                            if (f.category === cat && f.topic === topic.name && f.content_type === ct) count++;
                        });
                    } else if (coverage[cat]) {
                        if (langFilter) {
                            if (coverage[cat][langFilter] && coverage[cat][langFilter][topic.name] && coverage[cat][langFilter][topic.name][ct])
                                count = coverage[cat][langFilter][topic.name][ct];
                        } else {
                            Object.keys(coverage[cat]).forEach(function(lang){
                                if (coverage[cat][lang][topic.name] && coverage[cat][lang][topic.name][ct])
                                    count += coverage[cat][lang][topic.name][ct];
                            });
                        }
                    }
                    if (count > 0) {
                        cells += '<td class="cell-yes" onclick="matrixCellClick(\''+topic.name.replace(/'/g,"\\'")+'\',\''+ct+'\')">'+count+'</td>';
                    } else {
                        cells += '<td class="cell-no">&mdash;</td>';
                    }
                });
                rows.push('<tr data-section="'+cat+'" style="display:none;">'+cells+'</tr>');
            });
        });
        document.getElementById('matrixTableBody').innerHTML = rows.join('');
    }
    function matrixToggleSection(section) {
        var header = document.querySelector('[data-matrix-section="'+section+'"]');
        var rows = document.querySelectorAll('[data-section="'+section+'"]');
        var collapsed = header.classList.toggle('collapsed');
        rows.forEach(function(r){r.style.display = collapsed ? 'none' : '';});
    }
    function matrixCellClick(topic, ct) {
        filesFilter.topics.clear(); filesFilter.formats.clear(); filesFilter.categories.clear(); filesFilter.langs.clear(); filesFilter.statuses.clear(); filesFilter.search='';
        filesFilter.topics.add(topic); filesFilter.formats.add(ct);
        var langF = document.getElementById('matrixLangSelect').value;
        if (langF) filesFilter.langs.add(langF);
        document.getElementById('filesSearchInput').value = '';
        filesPage = 0; filesApplyFilters(); switchTab('files');
    }

    /* FILES */
    var filesFilter = { product:'all', categories:new Set(), topics:new Set(), formats:new Set(), langs:new Set(), statuses:new Set(), search:'' };
    var filesSortKey = 'name', filesSortDir = 1, filesPage = 0, filesPerPage = 30;

    function filesInitFilters() {
        buildMsDropdown('msCategoryDropdown','Category',CATEGORIES,'categories',false);
        var topicsByGroup = {};
        CATEGORIES.forEach(function(cat){topicsByGroup[cat]=DATA.topics.filter(function(t){return t.category===cat;}).map(function(t){return t.name;});});
        buildMsDropdown('msTopicDropdown','Topic',topicsByGroup,'topics',true);
        var fmts = DATA.content_types.map(function(c){return c.name;});
        buildMsDropdown('msFormatDropdown','Type',fmts,'formats',false);
        var langs = DATA.languages.map(function(l){return l.code;});
        buildMsDropdown('msLangDropdown','Language',langs,'langs',false);
        buildMsDropdown('msStatusDropdown','Status',['published','draft'],'statuses',false);
    }

    function buildMsDropdown(containerId, label, options, filterKey, grouped) {
        var wrapper = document.getElementById(containerId);
        var trigger = document.createElement('button');
        trigger.className = 'ms-trigger';
        trigger.innerHTML = '<span class="ms-label">'+label+'</span><svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5l3 3 3-3"/></svg>';
        var panel = document.createElement('div');
        panel.className = 'ms-panel';
        if (grouped) {
            Object.keys(options).forEach(function(group){
                var gh = document.createElement('div'); gh.className='ms-panel-group'; gh.textContent=group; panel.appendChild(gh);
                options[group].forEach(function(val){ panel.appendChild(makeMsOption(val,filterKey,trigger,label)); });
            });
        } else {
            options.forEach(function(val){ panel.appendChild(makeMsOption(val,filterKey,trigger,label)); });
        }
        wrapper.appendChild(trigger); wrapper.appendChild(panel);
        trigger.addEventListener('click', function(e){ e.stopPropagation(); document.querySelectorAll('.ms-dropdown.open').forEach(function(d){if(d!==wrapper)d.classList.remove('open');}); wrapper.classList.toggle('open'); });
    }
    function makeMsOption(val, filterKey, trigger, label) {
        var opt = document.createElement('div'); opt.className='ms-option'; opt.dataset.value=val;
        opt.innerHTML = '<div class="ms-check"></div><span>'+val+'</span>';
        opt.addEventListener('click', function(e){
            e.stopPropagation();
            var set = filesFilter[filterKey];
            if(set.has(val)){set.delete(val);opt.classList.remove('selected');}else{set.add(val);opt.classList.add('selected');}
            updateMsTrigger(trigger,label,set);
            filesPage=0; filesApplyFilters();
        });
        return opt;
    }
    function updateMsTrigger(trigger,label,set) {
        if(set.size===0){trigger.innerHTML='<span class="ms-label">'+label+'</span><svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5l3 3 3-3"/></svg>';trigger.classList.remove('has-selection');}
        else{trigger.innerHTML='<span class="ms-label">'+label+'</span><span class="ms-badge">'+set.size+'</span><svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5l3 3 3-3"/></svg>';trigger.classList.add('has-selection');}
    }
    document.addEventListener('click', function(){document.querySelectorAll('.ms-dropdown.open').forEach(function(d){d.classList.remove('open');});});

    function filesSetProduct(p,btn){filesFilter.product=p;btn.closest('.overview-pills').querySelectorAll('.pill-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');filesPage=0;filesApplyFilters();}
    function filesClearAll(){filesFilter.categories.clear();filesFilter.topics.clear();filesFilter.formats.clear();filesFilter.langs.clear();filesFilter.statuses.clear();filesFilter.search='';document.getElementById('filesSearchInput').value='';document.querySelectorAll('#tab-files .ms-option.selected').forEach(function(o){o.classList.remove('selected');});document.querySelectorAll('#tab-files .ms-trigger').forEach(function(t){t.classList.remove('has-selection');var lbl=t.querySelector('.ms-label');if(lbl){t.innerHTML='<span class="ms-label">'+lbl.textContent+'</span><svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5l3 3 3-3"/></svg>';}});filesPage=0;filesApplyFilters();}

    function filesGetFiltered() {
        return DATA.files.filter(function(f){
            if(filesFilter.product!=='all'&&f.product!==filesFilter.product) return false;
            if(filesFilter.categories.size>0&&!filesFilter.categories.has(f.category)) return false;
            if(filesFilter.topics.size>0&&!filesFilter.topics.has(f.topic)) return false;
            if(filesFilter.formats.size>0&&!filesFilter.formats.has(f.content_type)) return false;
            if(filesFilter.langs.size>0&&!filesFilter.langs.has(f.language)) return false;
            if(filesFilter.statuses.size>0&&!filesFilter.statuses.has(f.status)) return false;
            if(filesFilter.search){var q=filesFilter.search.toLowerCase();if(!f.name.toLowerCase().includes(q)&&!(f.title&&f.title.toLowerCase().includes(q))) return false;}
            return true;
        });
    }

    function filesApplyFilters() {
        filesFilter.search = document.getElementById('filesSearchInput').value;
        var filtered = filesGetFiltered();
        filtered.sort(function(a,b){
            var va=a[filesSortKey]||'', vb=b[filesSortKey]||'';
            if(typeof va==='string') va=va.toLowerCase();
            if(typeof vb==='string') vb=vb.toLowerCase();
            if(va<vb) return -1*filesSortDir;
            if(va>vb) return 1*filesSortDir;
            return 0;
        });
        var total = filtered.length;
        var activeCount = filesFilter.categories.size+filesFilter.topics.size+filesFilter.formats.size+filesFilter.langs.size+filesFilter.statuses.size;
        document.getElementById('filesCount').innerHTML = activeCount>0 ? '<strong>'+total+'</strong> of '+DATA.total_files+' ('+activeCount+' filters)' : '<strong>'+total+'</strong> files';
        var totalPages = Math.ceil(total/filesPerPage);
        if(filesPage>=totalPages) filesPage=Math.max(0,totalPages-1);
        var start = filesPage*filesPerPage;
        var pageItems = filtered.slice(start,start+filesPerPage);
        var tbody = document.getElementById('filesTableBody');
        if(pageItems.length===0){
            tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted);">No files match filters</td></tr>';
        } else {
            var rr = [];
            pageItems.forEach(function(f){
                var statusTag = f.status==='published'?'<span class="tag tag-green">published</span>':'<span class="tag tag-amber">draft</span>';
                var ctDn = DATA.content_types.find(function(c){return c.name===f.content_type;});
                var sizeKb = (f.size/1024).toFixed(1);
                rr.push('<tr><td class="file-name-cell">'+f.name+'</td><td style="color:var(--text-secondary);font-size:0.75rem;">'+(f.category||'-')+'</td><td>'+(f.topic||'-')+'</td><td><span class="tag tag-blue">'+(ctDn?ctDn.display_name:f.content_type)+'</span></td><td><span class="tag tag-gray">'+(f.language?f.language.toUpperCase():'-')+'</span></td><td>'+statusTag+'</td><td style="color:var(--text-muted);">'+sizeKb+' KB</td></tr>');
            });
            tbody.innerHTML = rr.join('');
        }
        document.getElementById('filesPagInfo').textContent = total>0 ? 'Showing '+(start+1)+'-'+Math.min(start+filesPerPage,total)+' of '+total : '';
        document.getElementById('filesPrev').disabled = filesPage===0;
        document.getElementById('filesNext').disabled = filesPage>=totalPages-1;
        ['name','category','topic','content_type','language','status','size'].forEach(function(k){
            var el=document.getElementById('sort-'+k);
            if(el) el.textContent=filesSortKey===k?(filesSortDir===1?'\u25B2':'\u25BC'):'';
        });
        filesRenderActiveTags();
    }
    function filesSort(key){if(filesSortKey===key)filesSortDir*=-1;else{filesSortKey=key;filesSortDir=1;}filesApplyFilters();}
    function filesPageChange(dir){filesPage+=dir;filesApplyFilters();}
    function filesRenderActiveTags(){
        var c=document.getElementById('filesActiveTags');
        var all=[];
        ['categories','topics','formats','langs','statuses'].forEach(function(k){filesFilter[k].forEach(function(v){all.push({key:k,val:v});});});
        if(all.length===0){c.innerHTML='';return;}
        c.innerHTML=all.map(function(f){return '<span class="active-tag">'+f.val+'<button onclick="filesRemoveTag(\''+f.key+'\',\''+f.val.replace(/'/g,"\\'")+'\')">&times;</button></span>';}).join('');
    }
    function filesRemoveTag(key,val){filesFilter[key].delete(val);document.querySelectorAll('#tab-files .ms-option[data-value="'+val+'"]').forEach(function(o){o.classList.remove('selected');});filesPage=0;filesApplyFilters();}

    /* GAPS */
    var gapsProduct = 'all';
    var gapCategoryWeights = { Features: 5, Competitors: 4, Business_Types: 3, Pains: 2, PM_Education: 1 };
    var gapCategoryTexts = {
        Features: 'Features â€” key section. Product capability content directly impacts conversion.',
        Competitors: 'Competitor comparisons are critical at the decision stage. Customers actively search for alternatives.',
        Business_Types: 'Industry content helps customers see product relevance for their business.',
        Pains: 'Pain-point content creates emotional connection and motivates action.',
        PM_Education: 'Educational content builds brand expertise and attracts organic traffic.'
    };
    var gapContentTypeTexts = {
        article: 'Article â€” the foundation of SEO traffic and trust.',
        video: 'Video â€” highest engagement and conversion rate.',
        landing: 'Landing â€” conversion point for targeted traffic.',
        static_ad: 'Static Ad â€” paid acquisition of target audience.',
        video_ad: 'Video Ad â€” high-impact paid promotion.',
        smm: 'SMM â€” organic reach and brand awareness.'
    };
    var gapLangWeights = { ua: 3, en: 3, ru: 2, pl: 1, pt: 1, fr: 1, it: 1, ro: 1, kz: 1 };
    var gapLangTexts = {
        ua: 'Ukrainian â€” primary market, highest priority.',
        en: 'English â€” global reach, critical for growth.',
        ru: 'Russian â€” secondary market with existing audience.',
        pl: 'Polish â€” expansion market.',
        pt: 'Portuguese â€” expansion market.',
        fr: 'French â€” expansion market.',
        it: 'Italian â€” expansion market.',
        ro: 'Romanian â€” expansion market.',
        kz: 'Kazakh â€” expansion market.'
    };
    function gapsSetProduct(p,btn){gapsProduct=p;btn.closest('.overview-pills').querySelectorAll('.pill-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');gapsRender();}
    function initGapsFilters() {
        var langSel = document.getElementById('gapsLangSelect');
        DATA.languages.forEach(function(l){var o=document.createElement('option');o.value=l.code;o.textContent=l.code.toUpperCase();langSel.appendChild(o);});
        var catSel = document.getElementById('gapsCategorySelect');
        CATEGORIES.forEach(function(c){var o=document.createElement('option');o.value=c;o.textContent=c;catSel.appendChild(o);});
    }
    function gapCalcScore(g) {
        var cw = gapCategoryWeights[g.category] || 1;
        var lw = gapLangWeights[g.language] || 1;
        return cw * lw;
    }
    function gapsRender() {
        var sevFilter = document.getElementById('gapsSeveritySelect').value;
        var langFilter = document.getElementById('gapsLangSelect').value;
        var catFilter = document.getElementById('gapsCategorySelect').value;
        var gaps = DATA.gaps.filter(function(g){
            if(sevFilter && g.priority !== parseInt(sevFilter)) return false;
            if(langFilter && g.language !== langFilter) return false;
            if(catFilter && g.category !== catFilter) return false;
            if(gapsProduct === 'ws1' && !g.category) return false;
            if(gapsProduct === 'ws2' && g.category) return false;
            return true;
        });
        var groups = {1:{label:'Critical',color:'#EF4444',bg:'rgba(239,68,68,0.1)',items:[]},2:{label:'High',color:'#F59E0B',bg:'rgba(245,158,11,0.1)',items:[]},3:{label:'Medium',color:'#6B7280',bg:'rgba(107,114,128,0.1)',items:[]},4:{label:'Low',color:'#9CA3AF',bg:'rgba(156,163,175,0.1)',items:[]}};
        gaps.forEach(function(g){if(groups[g.priority])groups[g.priority].items.push(g);});
        var html = '';
        [1,2,3,4].forEach(function(p){
            var grp=groups[p];
            if(grp.items.length===0) return;
            html += '<div class="gaps-group"><div class="gaps-group-header"><div class="gaps-group-dot" style="background:'+grp.color+';"></div><span class="gaps-group-title" style="color:'+grp.color+';">'+grp.label+'</span><span class="gaps-group-count" style="background:'+grp.bg+';color:'+grp.color+';">'+grp.items.length+'</span></div><div class="gaps-list">';
            grp.items.forEach(function(g){
                var ctDn = DATA.content_types.find(function(c){return c.name===g.content_type;});
                var ctName = ctDn ? ctDn.display_name : g.content_type;
                var score = gapCalcScore(g);
                var cw = gapCategoryWeights[g.category] || 1;
                var lw = gapLangWeights[g.language] || 1;
                var catText = gapCategoryTexts[g.category] || '';
                var ctText = gapContentTypeTexts[g.content_type] || '';
                var langText = gapLangTexts[g.language] || '';
                html += '<div class="gap-item" onclick="gapToggle(this)"><div><div class="gap-feature">'+g.topic_display+'</div><div class="gap-type">'+ctName+' | '+g.language.toUpperCase()+'</div><div class="gap-path">'+g.category+'</div></div><div class="gap-score" style="color:'+grp.color+';">'+score+'</div></div>';
                html += '<div class="gap-explanation"><strong>'+g.topic_display+' &times; '+ctName+' ('+g.language.toUpperCase()+')</strong><br>';
                html += 'Score: '+score+' ('+g.category+' &times;'+cw+' &middot; '+g.language.toUpperCase()+' &times;'+lw+')<br><br>';
                html += catText+'<br>'+ctText+'<br>'+langText+'</div>';
            });
            html += '</div></div>';
        });
        document.getElementById('gapsListContainer').innerHTML = html;
        document.getElementById('gapsDesc').textContent = gaps.length + ' gaps found' + (DATA.gaps.length !== gaps.length ? ' (of '+DATA.gaps.length+' total)' : '');
    }
    function gapToggle(el){var exp=el.nextElementSibling;if(!exp||!exp.classList.contains('gap-explanation'))return;var isOpen=exp.classList.toggle('open');el.classList.toggle('expanded',isOpen);}

    /* FOLDER EXPLORER */
    var folderNavStack = [], currentFolder = null, currentFolderChildren = [];
    function openStageFiles(product, stage) {
        var files = DATA.files.filter(function(f){return f.product===product&&f.stage===stage;});
        var root = {name:stage, path:'Content/'+product+'/'+stage, children:[], files:[]};
        CATEGORIES.forEach(function(cat){
            var cf = files.filter(function(f){return f.category===cat;});
            var catNode = {name:cat, path:'Content/'+product+'/'+stage+'/'+cat, children:[], files:[], file_count:cf.length, is_empty:cf.length===0};
            var topicMap = {};
            cf.forEach(function(f){if(f.topic){if(!topicMap[f.topic])topicMap[f.topic]=[];topicMap[f.topic].push(f);}else{catNode.files.push(f);}});
            Object.keys(topicMap).forEach(function(t){catNode.children.push({name:t,path:'Content/'+product+'/'+stage+'/'+cat+'/'+t,children:[],files:topicMap[t],file_count:topicMap[t].length,is_empty:false});});
            root.children.push(catNode);
        });
        root.file_count = files.length;
        folderNavStack = [];
        currentFolder = root;
        renderFolderContent();
        document.getElementById('folderOverlay').classList.add('open');
    }
    function openReleaseFolder(ct) {
        var files = DATA.files.filter(function(f){return f.product==='WS 2.0 Release'&&f.content_type===ct;});
        var ctDn = DATA.content_types.find(function(c){return c.name===ct;});
        var root = {name:ctDn?ctDn.display_name:ct, path:'Content/WS 2.0 Release/'+ct, children:[], files:files, file_count:files.length, is_empty:files.length===0};
        folderNavStack = [];
        currentFolder = root;
        renderFolderContent();
        document.getElementById('folderOverlay').classList.add('open');
    }
    function renderFolderContent() {
        if(!currentFolder) return;
        document.getElementById('folderModalTitle').textContent = currentFolder.name;
        document.getElementById('folderModalPath').textContent = currentFolder.path||'';
        document.getElementById('folderBackBtn').disabled = folderNavStack.length === 0;
        var emptyCount = currentFolder.children ? currentFolder.children.filter(function(c){return c.is_empty;}).length : 0;
        document.getElementById('folderFileCount').textContent = currentFolder.file_count||0;
        document.getElementById('folderEmptyCount').textContent = emptyCount>0 ? emptyCount+' empty folders' : '';
        var body = document.getElementById('folderModalBody');
        if((!currentFolder.children||currentFolder.children.length===0)&&(!currentFolder.files||currentFolder.files.length===0)){body.innerHTML='<div class="folder-empty-state">Empty folder</div>';return;}
        var html='';
        if(currentFolder.children && currentFolder.children.length>0){
            html+='<div class="folder-section-label">Subfolders</div>';
            currentFolderChildren = currentFolder.children.slice().sort(function(a,b){return (b.file_count||0)-(a.file_count||0);});
            currentFolderChildren.forEach(function(child,i){
                var emptyClass = child.is_empty ? ' empty' : '';
                var iconColor = child.is_empty ? '#EF4444' : '#3B82F6';
                html+='<div class="folder-item'+emptyClass+'" onclick="navigateToFolder('+i+')"><div class="folder-item-left"><svg class="folder-item-icon" style="color:'+iconColor+'" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg><span class="folder-item-name">'+child.name+'</span></div><div class="folder-item-right"><span class="folder-item-count">'+(child.file_count||0)+' files</span><svg class="folder-item-arrow" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div></div>';
            });
        }
        if(currentFolder.files && currentFolder.files.length>0){
            html+='<div class="folder-section-label">Files</div>';
            currentFolder.files.sort(function(a,b){return new Date(b.modified)-new Date(a.modified);}).forEach(function(f){
                var d=new Date(f.modified);
                var ds=d.toLocaleDateString('uk-UA',{day:'numeric',month:'short'});
                html+='<div class="file-item"><div class="file-item-left"><svg class="file-item-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/></svg><span class="file-item-name">'+f.name+'</span></div><span class="file-item-date">'+ds+'</span></div>';
            });
        }
        body.innerHTML = html;
    }
    function navigateToFolder(idx){if(idx>=0&&idx<currentFolderChildren.length){folderNavStack.push(currentFolder);currentFolder=currentFolderChildren[idx];renderFolderContent();}}
    function navigateBack(){if(folderNavStack.length>0){currentFolder=folderNavStack.pop();renderFolderContent();}}
    function closeFolderModal(){document.getElementById('folderOverlay').classList.remove('open');folderNavStack=[];currentFolder=null;}
    </script>
</body>
</html>
